name: ğŸš€ Build & Deploy

on:
  push:
    branches: [ TEST ]
  pull_request:
    branches: [ TEST ]
  workflow_dispatch:

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME: cysu

jobs:
  test:
    name: ğŸ§ª Tests & Quality
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8
    
    - name: ğŸ” Code quality check
      run: |
        echo "ğŸ” Running flake8 analysis..."
        flake8 app/ run.py --max-line-length=120 --ignore=E501,W503,W293,W291,W292,E302,E303,E305,F401,F841,E402,F541,E128,W391
        echo "âœ… Code quality check passed"
    
    - name: ğŸ§ª Run tests
      run: |
        echo "ğŸ§ª Running basic tests..."
        python -c "import app; print('âœ… App imports successfully')"
        echo "âœ… Basic tests passed"

  build:
    name: ğŸ³ Build Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/TEST'
    outputs:
      image: ${{ steps.build.outputs.image }}
      digest: ${{ steps.build.outputs.digest }}
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ” Login to Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ğŸ—ï¸ Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

  release:
    name: ğŸš€ Create Release & Package
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/TEST'
    outputs:
      version: ${{ steps.version.outputs.new_version }}
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ”§ Setup Git
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
    
    - name: ğŸ“ˆ Calculate version
      id: version
      run: |
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‚ĞµĞ³
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
        echo "ğŸ“Œ Last tag: $LAST_TAG"
        
        # ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ğ²ĞµÑ€ÑĞ¸Ñ
        IFS='.' read -r major minor patch <<< "$LAST_TAG"
        
        # Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ patch Ğ²ĞµÑ€ÑĞ¸Ñ
        patch=$((patch + 1))
        
        NEW_VERSION="$major.$minor.$patch"
        echo "ğŸ¯ New version: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
    
    - name: ğŸ“¦ Create source package
      run: |
        echo "ğŸ“¦ Creating source package..."
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸
        mkdir -p temp_package
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹, Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ Ğ½ĞµĞ½ÑƒĞ¶Ğ½Ñ‹Ğµ
        rsync -av --exclude='.git' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.env' \
          --exclude='app.db' \
          --exclude='logs' \
          --exclude='temp_package' \
          --exclude='.github/workflows' \
          . temp_package/
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°Ñ€Ñ…Ğ¸Ğ² Ğ¸Ğ· Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
        tar -czf cysu-source-v${{ steps.version.outputs.new_version }}.tar.gz -C temp_package .
        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
        rm -rf temp_package
        echo "âœ… Source package created: cysu-source-v${{ steps.version.outputs.new_version }}.tar.gz"
    
    - name: ğŸ“ Create GitHub Release with Package
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: cysu-source-v${{ steps.version.outputs.new_version }}.tar.gz
        tag_name: v${{ steps.version.outputs.new_version }}
        name: ğŸš€ Release v${{ steps.version.outputs.new_version }}
        generate_release_notes: true
        body: |
          ## ğŸ‰ New Release v${{ steps.version.outputs.new_version }}
          
          ### âœ… Quality Checks
          - **Code Quality**: All flake8 checks passed
          - **Python Version**: 3.11
          - **Tests**: Basic import tests passed
          
          ### ğŸ³ Docker Images
          - **Latest**: `${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest`
          - **Tagged**: `${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}`
          
          ### ğŸ“¦ Packages
          - **Source Code**: `cysu-source-v${{ steps.version.outputs.new_version }}.tar.gz`
          
          ### ğŸš€ How to use
          ```bash
          # Pull latest image
          docker pull ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          
          # Run container
          docker run -d -p 8001:8001 \
            -e SECRET_KEY=your-secret-key \
            -e DATABASE_URL=sqlite:///app.db \
            ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          ```
          
          ---
          *ğŸ¤– This release was created automatically by GitHub Actions*
        draft: false
        prerelease: false

  deploy:
    name: ğŸš€ Deploy Summary
    needs: [build, release]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/TEST'
    steps:
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸ³ Docker Image: ${{ needs.build.outputs.image }}"
        echo "ğŸ“ Digest: ${{ needs.build.outputs.digest }}"
        echo "ğŸ·ï¸ Version: v${{ needs.release.outputs.version }}"
        echo "ğŸ“¦ Package: cysu-source-v${{ needs.release.outputs.version }}.tar.gz"
        echo "ğŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.release.outputs.version }}"