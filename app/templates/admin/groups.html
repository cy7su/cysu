{% extends 'base.html' %}
{% from 'macros/breadcrumbs.html' import admin_breadcrumb %}

{% block title %}Админка: Управление группами{% endblock %}

{% block breadcrumbs %}
{{ admin_breadcrumb("Группы") }}
{% endblock %}

{% block content %}
<div class="container-fluid admin-groups">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Управление группами</h2>
    <span class="badge bg-primary fs-6">{{ groups|length }} групп</span>
  </div>

  <div class="row g-4">
    <div class="col-lg-3">
      <div class="card shadow-sm border-0" style="background: var(--dp-02); height: fit-content;">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="fas fa-layer-group me-2 text-primary"></i>Создать группу
          </h5>
          <form method="post">
            {{ form.hidden_tag() }}
            <div class="mb-3">
              <label for="{{ form.name.id }}" class="form-label">Название группы</label>
              {{ form.name(class_='form-control', placeholder='Введите название группы') }}
              {% if form.name.errors %}
                <div class="text-danger small">
                  {% for error in form.name.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label for="{{ form.description.id }}" class="form-label">Описание</label>
              {{ form.description(class_='form-control', placeholder='Описание группы (необязательно)', rows=3) }}
              {% if form.description.errors %}
                <div class="text-danger small">
                  {% for error in form.description.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <button type="submit" name="submit" value="Сохранить" class="btn btn-primary w-100">
              <i class="fas fa-plus me-2"></i>Создать группу
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-9">
      <div class="card shadow-sm border-0" style="background: var(--dp-02);">
        <div class="card-body p-0">
          <div class="table-responsive" style="border-radius: 14px;">
            <table class="table mb-0" style="background: var(--dp-02); color: var(--text-primary); font-size: 0.9em;">
              <thead style="background: var(--dp-03);">
                <tr>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">ID</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Название</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Описание</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Пользователей</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Предметов</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Действия</th>
                </tr>
              </thead>
              <tbody style="background: var(--dp-02);">
                {% if groups %}
                  {% for group in groups %}
                  <tr style="border-color: var(--border-secondary); background: var(--dp-02); color: var(--text-primary);" data-group-id="{{ group.id }}">
                    <td style="color: var(--text-primary);"><span class="badge bg-secondary">{{ group.id }}</span></td>
                    <td style="color: var(--text-primary);">
                      <strong>{{ group.name }}</strong>
                    </td>
                    <td style="color: var(--text-primary);">
                      <small class="text-muted">{{ group.description or 'Нет описания' }}</small>
                    </td>
                    <td style="color: var(--text-primary);">
                      <span class="badge bg-primary">{{ group.users|length }}</span>
                    </td>
                    <td style="color: var(--text-primary);">
                      <span class="badge bg-secondary">{{ group.subjects|length }}</span>
                    </td>
                    <td style="color: var(--text-primary);">
                      <div class="d-flex gap-1">
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                onclick="enableEditMode({{ group.id }}, '{{ group.name }}', '{{ group.description or 'Нет описания' }}', 1)">
                          <i class="fas fa-edit"></i>
                        </button>
                        
                        <form method="post" style="display: inline;">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="action" value="delete">
                          <input type="hidden" name="group_id" value="{{ group.id }}">
                          <button type="submit" class="btn btn-sm btn-outline-danger" 
                                  onclick="return confirm('Вы уверены, что хотите удалить группу &quot;{{ group.name }}&quot;?')">
                            <i class="fas fa-trash"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr style="background: var(--dp-02); color: var(--text-primary);">
                    <td colspan="6" class="text-center text-muted py-4" style="color: var(--text-primary);">
                      <i class="fas fa-layer-group fa-2x mb-3"></i>
                      <p>Нет групп</p>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block head %}
<script>
// Функция для включения режима редактирования прямо в таблице
function enableEditMode(groupId, currentName, currentDescription) {
    const row = document.querySelector(`tr[data-group-id="${groupId}"]`);
    if (!row) return;
    
    // Сохраняем оригинальные значения
    const originalName = currentName;
    const originalDescription = currentDescription;
    
    // Находим ячейки для редактирования
    const nameCell = row.querySelector('td:nth-child(2)');
    const descriptionCell = row.querySelector('td:nth-child(3)');
    const actionsCell = row.querySelector('td:nth-child(6)');
    
    if (!nameCell || !descriptionCell || !actionsCell) return;
    
    // Создаем поля ввода для названия
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className = 'form-control form-control-sm';
    nameInput.value = currentName;
    nameInput.style.cssText = 'background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 8px; width: 100%; font-size: 0.9em; padding: 0.2rem 0.4rem;';
    
    // Создаем поле для описания
    const descriptionInput = document.createElement('textarea');
    descriptionInput.className = 'form-control form-control-sm';
    descriptionInput.value = currentDescription === 'Нет описания' ? '' : currentDescription;
    descriptionInput.rows = '2';
    descriptionInput.style.cssText = 'background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 8px; width: 100%; resize: none; font-size: 0.85em; padding: 0.2rem 0.4rem; line-height: 1.2;';
    
    // Заменяем содержимое ячеек
    nameCell.innerHTML = '';
    nameCell.appendChild(nameInput);
    
    descriptionCell.innerHTML = '';
    descriptionCell.appendChild(descriptionInput);
    
    // Создаем кнопки сохранения/отмены
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-success btn-sm me-1';
    saveBtn.innerHTML = '<i class="fas fa-check"></i>';
    saveBtn.title = 'Сохранить';
    saveBtn.style.cssText = 'font-size: 0.65rem; padding: 0.2rem 0.4rem; min-width: 24px; height: 24px;';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn btn-secondary btn-sm';
    cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
    cancelBtn.title = 'Отменить';
    cancelBtn.style.cssText = 'font-size: 0.65rem; padding: 0.2rem 0.4rem; min-width: 24px; height: 24px;';
    
    // Очищаем ячейку действий и добавляем новые кнопки
    actionsCell.innerHTML = '';
    actionsCell.appendChild(saveBtn);
    actionsCell.appendChild(cancelBtn);
    
    // Фокус на первое поле
    nameInput.focus();
    nameInput.select();
    
    // Обработчик сохранения
    saveBtn.addEventListener('click', function() {
        const newName = nameInput.value.trim();
        const newDescription = descriptionInput.value.trim();
        
        if (!newName) {
            alert('Название группы не может быть пустым');
            return;
        }
        
        // Получаем CSRF токен
        const csrfToken = document.querySelector('input[name="csrf_token"]');
        if (!csrfToken || !csrfToken.value) {
            alert('Ошибка: CSRF токен не найден. Обновите страницу и попробуйте снова.');
            return;
        }
        
        // Отправляем данные на сервер
        const formData = new FormData();
        formData.append('action', 'edit');
        formData.append('group_id', groupId);
        formData.append('name', newName);
        formData.append('description', newDescription);
        formData.append('is_active', 1); // Все группы активны
        formData.append('csrf_token', csrfToken.value);
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // Проверяем, что ответ действительно JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // Если сервер вернул HTML вместо JSON, но статус успешный,
                // значит данные сохранились, просто сервер не вернул JSON
                if (response.status === 200) {
                    console.log('Сервер вернул HTML вместо JSON, но статус 200 - данные сохранены');
                    return { success: true, message: 'Данные обновлены' };
                } else {
                    // Попробуем прочитать текст ответа для диагностики
                    return response.text().then(text => {
                        console.log('HTML ответ сервера:', text.substring(0, 200) + '...');
                        throw new Error('Ответ сервера не является JSON');
                    });
                }
            }
            
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            
            if (data.success) {
                // Обновляем отображение
                restoreRow(row, newName, newDescription);
                alert('Группа успешно обновлена');
            } else {
                const errorMsg = data.error || 'Неизвестная ошибка';
                console.error('Server error:', errorMsg);
                alert('Ошибка при обновлении группы: ' + errorMsg);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            
            // Более информативное сообщение об ошибке
            let errorMessage = 'Ошибка при обновлении группы';
            if (error.message.includes('HTTP')) {
                errorMessage += `: ${error.message}`;
            } else if (error.message.includes('JSON')) {
                errorMessage += ': Сервер вернул неверный формат ответа';
            } else {
                errorMessage += ': ' + error.message;
            }
            
            alert(errorMessage);
            
            // Возвращаем строку в исходное состояние при ошибке
            restoreRow(row, originalName, originalDescription);
        });
    });
    
    // Обработчик отмены
    cancelBtn.addEventListener('click', function() {
        restoreRow(row, originalName, originalDescription);
    });
    
    // Обработчик Enter для сохранения
    nameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveBtn.click();
        }
    });
    
    descriptionInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            saveBtn.click();
        }
    });
}

// Функция для восстановления строки в обычном режиме
function restoreRow(row, name, description) {
    const nameCell = row.querySelector('td:nth-child(2)');
    const descriptionCell = row.querySelector('td:nth-child(3)');
    const actionsCell = row.querySelector('td:nth-child(6)');
    
    if (!nameCell || !descriptionCell || !actionsCell) return;
    
    const groupId = row.dataset.groupId;
    
    // Восстанавливаем название
    nameCell.innerHTML = `<strong>${name}</strong>`;
    
    // Восстанавливаем описание
    descriptionCell.innerHTML = `<small class="text-muted">${description || 'Нет описания'}</small>`;
    
    // Восстанавливаем кнопки действий
    actionsCell.innerHTML = `
        <div class="d-flex gap-1">
            <button type="button" class="btn btn-sm btn-outline-primary" 
                    onclick="enableEditMode(${groupId}, '${name}', '${description || 'Нет описания'}')">
                <i class="fas fa-edit"></i>
            </button>
            <form method="post" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="group_id" value="${groupId}">
                <button type="submit" class="btn btn-sm btn-outline-danger" 
                        onclick="return confirm('Вы уверены, что хотите удалить группу &quot;${name}&quot;?')">
                    <i class="fas fa-trash"></i>
                </button>
            </form>
        </div>
    `;
}
</script>
{% endblock %}
