{% extends 'base.html' %}
{% block title %}Админка: Управление группами{% endblock %}

{% block content %}
<div class="container-fluid admin-groups">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Управление группами</h2>
    <span class="badge bg-primary fs-6">{{ groups|length }} групп</span>
  </div>

  <div class="row g-4">
    <div class="col-12">
      <div class="card shadow-sm border-0" style="background: none;">
        <div class="card-body p-0">
          <div class="d-flex justify-content-between align-items-center mb-3 p-3" style="background: var(--dp-01); border-radius: 8px;">
            <div class="d-flex align-items-center gap-3">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllGroups()">
                <i class="fas fa-check-square me-1"></i>Выбрать все
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllGroups()">
                <i class="fas fa-square me-1"></i>Снять выбор
              </button>
              <span class="text-muted" id="selected-count">Выбрано: 0</span>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-success" onclick="showCreateGroupModal()">
                <i class="fas fa-plus me-1"></i>Создать группу
              </button>
              <button type="button" class="btn btn-sm btn-danger" onclick="deleteSelectedGroups()" disabled id="mass-delete-btn">
                <i class="fas fa-trash me-1"></i>Удалить
              </button>
            </div>
          </div>

          <div class="table-responsive" style="border-radius: 14px;">
            <table class="table mb-0" style="background: var(--dp-02); color: var(--text-primary); font-size: 0.9em;">
              <thead style="background: var(--dp-03);">
                <tr>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem; width: 40px;">
                    <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()">
                  </th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">
                    <button class="btn btn-link p-0 text-decoration-none" onclick="sortTable('id')" style="color: var(--text-primary);">
                      ID <i class="fas fa-sort ms-1"></i>
                    </button>
                  </th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">
                    <button class="btn btn-link p-0 text-decoration-none" onclick="sortTable('name')" style="color: var(--text-primary);">
                      Название <i class="fas fa-sort ms-1"></i>
                    </button>
                  </th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">
                    <button class="btn btn-link p-0 text-decoration-none" onclick="sortTable('description')" style="color: var(--text-primary);">
                      Описание <i class="fas fa-sort ms-1"></i>
                    </button>
                  </th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">
                    <button class="btn btn-link p-0 text-decoration-none" onclick="sortTable('users')" style="color: var(--text-primary);">
                      Пользователей <i class="fas fa-sort ms-1"></i>
                    </button>
                  </th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">
                    <button class="btn btn-link p-0 text-decoration-none" onclick="sortTable('subjects')" style="color: var(--text-primary);">
                      Предметов <i class="fas fa-sort ms-1"></i>
                    </button>
                  </th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Действия</th>
                </tr>
              </thead>
              <tbody style="background: var(--dp-02);" id="groups-table-body">
                {% if groups %}
                {% for group in groups %}
                  <tr style="border-color: var(--border-secondary); background: var(--dp-02); color: var(--text-primary);" data-group-id="{{ group.id }}">
                    <td style="color: var(--text-primary);">
                      <input type="checkbox" class="group-checkbox" value="{{ group.id }}" onchange="updateSelectedCount()">
                    </td>
                    <td style="color: var(--text-primary);">
                      <span class="badge bg-secondary">{{ group.id }}</span>
                    </td>
                    <td style="color: var(--text-primary);">
                      <div class="d-flex align-items-center gap-2">
                        <strong>{{ group.name }}</strong>
                      </div>
                    </td>
                    <td style="color: var(--text-primary);">
                      <div class="d-flex align-items-center gap-2">
                        <span class="text-truncate" style="max-width: 200px;">{{ group.description or 'Нет описания' }}</span>
                      </div>
                    </td>
                    <td style="color: var(--text-primary);">
                      <span class="badge bg-primary">{{ group.users|length }}</span>
                    </td>
                    <td style="color: var(--text-primary);">
                      <span class="badge bg-info">{{ group.subjects|length }}</span>
                    </td>
                    <td style="color: var(--text-primary);">
                      <div class="d-flex gap-1">
                        <button type="button" class="btn btn-warning btn-sm edit-group-btn" 
                                data-group-id="{{ group.id }}" data-name="{{ group.name|e }}" data-description="{{ (group.description or '')|e }}"
                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem;" title="Редактировать">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm delete-group-btn" 
                                data-group-id="{{ group.id }}" data-name="{{ group.name|e }}"
                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem;" title="Удалить">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
                {% else %}
                  <tr style="background: var(--dp-02); color: var(--text-primary);">
                    <td colspan="7" class="text-center text-muted py-4" style="color: var(--text-primary);">
                      <i class="fas fa-layer-group fa-2x mb-3"></i>
                      <p>Нет групп</p>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для создания группы -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createGroupModalLabel">Создать группу</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="create-group-form">
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="submit" value="Сохранить">
          
          <div class="mb-3">
            <label class="form-label">Название группы</label>
            <input type="text" name="name" id="create_name" class="form-control" required
                   style="background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 20px;">
          </div>
          
          <div class="mb-3">
            <label class="form-label">Описание</label>
            <textarea name="description" id="create_description" class="form-control" rows="3"
                      style="background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 20px;"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Создать</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Модальное окно для редактирования группы -->
<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editGroupModalLabel">Редактировать группу</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="edit-group-form">
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="action" value="edit">
          <input type="hidden" name="group_id" id="edit_group_id">
          
          <div class="mb-3">
            <label class="form-label">Название группы</label>
            <input type="text" name="name" id="edit_name" class="form-control" required
                   style="background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 20px;">
          </div>
          
          <div class="mb-3">
            <label class="form-label">Описание</label>
            <textarea name="description" id="edit_description" class="form-control" rows="3"
                      style="background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 20px;"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Сохранить</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block head %}
<style>
/* Стили для input элементов на странице groups */
.admin-groups input {
    margin-left: 15px;
}
</style>

<script>
let currentSortColumn = null;
let currentSortDirection = 'asc';

document.addEventListener('DOMContentLoaded', function() {
    // Улучшение работы с select элементами
    const selects = document.querySelectorAll('select');
    
    selects.forEach(select => {
        select.style.cssText = 'background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 20px;';
    });
    
    // Улучшение UX для модальных окон
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            const firstInput = this.querySelector('input, select');
            if (firstInput) {
                firstInput.focus();
            }
        });
    });
    
    // Обработчики для кнопок действий
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-group-btn')) {
            const btn = e.target.closest('.edit-group-btn');
            const groupId = btn.dataset.groupId;
            const name = btn.dataset.name;
            const description = btn.dataset.description;
            editGroup(groupId, name, description);
        } else if (e.target.closest('.delete-group-btn')) {
            const btn = e.target.closest('.delete-group-btn');
            const groupId = btn.dataset.groupId;
            const name = btn.dataset.name;
            deleteGroup(groupId, name);
        }
    });
});

// Функции для массовых операций
function selectAllGroups() {
    const checkboxes = document.querySelectorAll('.group-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    updateSelectedCount();
}

function deselectAllGroups() {
    const checkboxes = document.querySelectorAll('.group-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateSelectedCount();
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const checkboxes = document.querySelectorAll('.group-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.group-checkbox:checked');
    const count = checkboxes.length;
    const countElement = document.getElementById('selected-count');
    const massDeleteBtn = document.getElementById('mass-delete-btn');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    
    countElement.textContent = `Выбрано: ${count}`;
    
    // Включаем/выключаем кнопки массовых операций
    massDeleteBtn.disabled = count === 0;
    
    // Обновляем состояние главного чекбокса
    const allCheckboxes = document.querySelectorAll('.group-checkbox');
    if (count === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (count === allCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function deleteSelectedGroups() {
    const selectedCheckboxes = document.querySelectorAll('.group-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Выберите группы для удаления');
        return;
    }
    
    customConfirm(
        `Удалить ${selectedCheckboxes.length} групп? Это действие нельзя отменить!`,
        function() {
    
    // Создаем форму для массового удаления
    const form = document.createElement('form');
    form.method = 'post';
    form.style.display = 'none';
    
    // Добавляем CSRF токен
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = document.querySelector('input[name="csrf_token"]').value;
    form.appendChild(csrfInput);
    
    // Добавляем действие
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'mass_delete';
    form.appendChild(actionInput);
    
    // Добавляем выбранные группы
    selectedCheckboxes.forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'group_ids';
        input.value = checkbox.value;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}

// Функции для отдельных групп
function showCreateGroupModal() {
    // Очищаем форму
    document.getElementById('create_name').value = '';
    document.getElementById('create_description').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('createGroupModal'));
    modal.show();
}

function editGroup(groupId, name, description) {
    document.getElementById('edit_group_id').value = groupId;
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_description').value = description;
    
    const modal = new bootstrap.Modal(document.getElementById('editGroupModal'));
    modal.show();
}

function deleteGroup(groupId, name) {
    customConfirm(
        `Удалить группу "${name}"? Это действие нельзя отменить!`,
        function() {
    
    const form = document.createElement('form');
    form.method = 'post';
    form.style.display = 'none';
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = document.querySelector('input[name="csrf_token"]').value;
    form.appendChild(csrfInput);
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'delete';
    form.appendChild(actionInput);
    
    const groupIdInput = document.createElement('input');
    groupIdInput.type = 'hidden';
    groupIdInput.name = 'group_id';
    groupIdInput.value = groupId;
    form.appendChild(groupIdInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Функции сортировки
function sortTable(column) {
    const tbody = document.getElementById('groups-table-body');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Определяем направление сортировки
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortDirection = 'asc';
        currentSortColumn = column;
    }
    
    // Сортируем строки
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch (column) {
            case 'id':
                aValue = parseInt(a.querySelector('td:nth-child(2) .badge').textContent);
                bValue = parseInt(b.querySelector('td:nth-child(2) .badge').textContent);
                break;
            case 'name':
                aValue = a.querySelector('td:nth-child(3) strong').textContent.toLowerCase();
                bValue = b.querySelector('td:nth-child(3) strong').textContent.toLowerCase();
                break;
            case 'description':
                const aDesc = a.querySelector('td:nth-child(4) span').textContent.toLowerCase();
                const bDesc = b.querySelector('td:nth-child(4) span').textContent.toLowerCase();
                aValue = aDesc.includes('нет описания') ? 'zzz' : aDesc;
                bValue = bDesc.includes('нет описания') ? 'zzz' : bDesc;
                break;
            case 'users':
                aValue = parseInt(a.querySelector('td:nth-child(5) .badge').textContent);
                bValue = parseInt(b.querySelector('td:nth-child(5) .badge').textContent);
                break;
            case 'subjects':
                aValue = parseInt(a.querySelector('td:nth-child(6) .badge').textContent);
                bValue = parseInt(b.querySelector('td:nth-child(6) .badge').textContent);
                break;
            default:
                return 0;
        }
        
        if (aValue < bValue) return currentSortDirection === 'asc' ? -1 : 1;
        if (aValue > bValue) return currentSortDirection === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Очищаем tbody и добавляем отсортированные строки
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Обновляем иконки сортировки
    updateSortIcons(column);
}

function updateSortIcons(activeColumn) {
    // Сбрасываем все иконки
    document.querySelectorAll('th button i').forEach(icon => {
        icon.className = 'fas fa-sort ms-1';
    });
    
    // Устанавливаем иконку для активной колонки
    const activeButton = document.querySelector(`button[onclick="sortTable('${activeColumn}')"]`);
    if (activeButton) {
        const icon = activeButton.querySelector('i');
        icon.className = currentSortDirection === 'asc' ? 'fas fa-sort-up ms-1' : 'fas fa-sort-down ms-1';
    }
}

// Функция для показа уведомлений
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
