{% extends 'base.html' %} {% block title %}Админка: Управление пользователями{% endblock %} {% block content %}
<div class="container-fluid admin-users">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Управление пользователями</h2>
        <span class="badge bg-primary fs-6">{{ users|length }} пользователей</span>
    </div>

    <div class="row g-4">
        <div class="col-12">
            <div class="card shadow-sm border-0" style="background: none">
                <div class="card-body p-0">
                    <div class="d-flex justify-content-between align-items-center mb-3 p-3"
                        style="background: var(--dp-01); border-radius: 8px">
                        <div class="d-flex align-items-center gap-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllUsers()">
                                <i class="fas fa-check-square me-1"></i>Выбрать все
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllUsers()">
                                <i class="fas fa-square me-1"></i>Снять выбор
                            </button>
                            <span class="text-muted" id="selected-count">Выбрано: 0</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-success" onclick="showMassGroupModal()" disabled
                                id="mass-group-btn">
                                <i class="fas fa-users me-1"></i>Назначить группу
                            </button>
                            <button type="button" class="btn btn-sm btn-warning" onclick="showMassStatusModal()"
                                disabled id="mass-status-btn">
                                <i class="fas fa-crown me-1"></i>Изменить статус
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteSelectedUsers()" disabled
                                id="mass-delete-btn">
                                <i class="fas fa-trash me-1"></i>Удалить
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive" style="border-radius: 14px">
                        <table class="table mb-0"
                            style="background: var(--dp-02); color: var(--text-primary); font-size: 0.9em">
                            <thead style="background: var(--dp-03)">
                                <tr>
                                    <th class="border-0" style="
                                            color: var(--text-primary);
                                            font-size: 0.9em;
                                            padding: 0.5rem;
                                            width: 40px;
                                        ">
                                        <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll()" />
                                    </th>
                                    <th class="border-0"
                                        style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem">
                                        <button class="btn btn-link p-0 text-decoration-none" onclick="sortTable('id')"
                                            style="color: var(--text-primary)">
                                            ID <i class="fas fa-sort ms-1"></i>
                                        </button>
                                    </th>
                                    <th class="border-0"
                                        style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem">
                                        Пользователь
                                    </th>
                                    <th class="border-0"
                                        style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem">
                                        <button class="btn btn-link p-0 text-decoration-none"
                                            onclick="sortTable('contact')" style="color: var(--text-primary)">
                                            Контакт <i class="fas fa-sort ms-1"></i>
                                        </button>
                                    </th>
                                    <th class="border-0"
                                        style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem">
                                        <button class="btn btn-link p-0 text-decoration-none"
                                            onclick="sortTable('group')" style="color: var(--text-primary)">
                                            Группа <i class="fas fa-sort ms-1"></i>
                                        </button>
                                    </th>
                                    <th class="border-0"
                                        style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem">
                                        <button class="btn btn-link p-0 text-decoration-none"
                                            onclick="sortTable('status')" style="color: var(--text-primary)">
                                            Статус <i class="fas fa-sort ms-1"></i>
                                        </button>
                                    </th>
                                    <th class="border-0"
                                        style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem">
                                        <button class="btn btn-link p-0 text-decoration-none"
                                            onclick="sortTable('subscription')" style="color: var(--text-primary)">
                                            Подписка <i class="fas fa-sort ms-1"></i>
                                        </button>
                                    </th>
                                    <th class="border-0"
                                        style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem">
                                        Действия
                                    </th>
                                </tr>
                            </thead>
                            <tbody style="background: var(--dp-02)" id="users-table-body">
                                {% if users %} {% for user in users %}
                                <tr style="
                                        border-color: var(--border-secondary);
                                        background: var(--dp-02);
                                        color: var(--text-primary);
                                    " data-user-id="{{ user.id }}">
                                    {% if password_map.get(user.id) %}
                                    <span style="display: none" data-password-for="{{ user.id }}"
                                        data-password="{{ password_map[user.id] }}"></span>
                                    {% endif %}
                                    <td style="color: var(--text-primary)">
                                        <input type="checkbox" class="user-checkbox" value="{{ user.id }}"
                                            onchange="updateSelectedCount()" />
                                    </td>
                                    <td style="color: var(--text-primary)">
                                        <span class="badge bg-secondary">{{ user.id }}</span>
                                    </td>
                                    <td style="color: var(--text-primary)">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center gap-2">
                                                <strong>{{ user.username }}</strong>
                                                {% if user.id == current_user.id %}
                                                <span class="badge bg-warning" style="font-size: 0.6rem">Вы</span>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">{{ submissions_count.get(user.id, 0) }}
                                                заданий</small>
                                        </div>
                                    </td>
                                    <td style="color: var(--text-primary)">
                                        <div class="d-flex align-items-center gap-2">
                                            {% if user.email %} {% if user.email.endswith('@telegram.org') %} {% set
                                            telegram_id = user.email.split('@')[0] %}
                                            <button type="button" class="btn btn-sm btn-outline-info"
                                                onclick="openTelegram('{{ telegram_id }}')" title="Открыть в Telegram"
                                                style="
                                                    width: 24px;
                                                    height: 24px;
                                                    padding: 0;
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                ">
                                                <i class="fab fa-telegram" style="font-size: 0.6rem"></i>
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                onclick="copyToClipboard('{{ user.email }}')" title="Копировать email"
                                                style="
                                                    width: 24px;
                                                    height: 24px;
                                                    padding: 0;
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                ">
                                                <i class="fas fa-copy" style="font-size: 0.6rem"></i>
                                            </button>
                                            {% endif %} {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td style="color: var(--text-primary)">
                                        {% if user.group %}
                                        <span class="badge bg-primary">{{ user.group.name }}</span>
                                        {% else %}
                                        <span class="text-muted">Без группы</span>
                                        {% endif %}
                                    </td>
                                    <td style="color: var(--text-primary)">
                                        {% if user.is_admin %}
                                        <span class="badge bg-danger">Админ</span>
                                        {% elif user.is_moderator %}
                                        <span class="badge bg-warning">Модератор</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Пользователь</span>
                                        {% endif %}
                                    </td>
                                    <td style="color: var(--text-primary)">
                                        {% if user.has_active_subscription() %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i>
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times"></i>
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td style="color: var(--text-primary)">
                                        <div class="d-flex gap-1">
                                            <button type="button" class="btn btn-warning btn-sm reset-password-btn"
                                                data-user-id="{{ user.id }}" data-username="{{ user.username|e }}"
                                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem"
                                                title="Сбросить пароль">
                                                <i class="fas fa-key"></i>
                                            </button>
                                            <button type="button" class="btn btn-info btn-sm change-group-btn"
                                                data-user-id="{{ user.id }}"
                                                data-current-group="{{ (user.group.name if user.group else '')|e }}"
                                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem"
                                                title="Изменить группу">
                                                <i class="fas fa-user-friends"></i>
                                            </button>
                                            <button type="button" class="btn btn-success btn-sm change-status-btn"
                                                data-user-id="{{ user.id }}"
                                                data-current-status="{{ ('admin' if user.is_admin else 'moderator' if user.is_moderator else 'user')|e }}"
                                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem"
                                                title="Изменить статус">
                                                <i class="fas fa-crown"></i>
                                            </button>
                                            <button type="button" class="btn btn-primary btn-sm toggle-subscription-btn"
                                                data-user-id="{{ user.id }}" data-username="{{ user.username|e }}"
                                                data-has-subscription="{{ user.has_active_subscription()|lower }}"
                                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem"
                                                title="{% if user.has_active_subscription() %}Отозвать подписку{% else %}Выдать подписку{% endif %}">
                                                <i
                                                    class="fas {% if user.has_active_subscription() %}fa-times{% else %}fa-check{% endif %}"></i>
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm edit-user-btn"
                                                data-user-id="{{ user.id }}" data-username="{{ user.username|e }}"
                                                data-email="{{ user.email|e }}"
                                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem"
                                                title="Редактировать данные">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            {% if user.id != current_user.id %}
                                            <button type="button" class="btn btn-danger btn-sm delete-user-btn"
                                                data-user-id="{{ user.id }}" data-username="{{ user.username|e }}"
                                                style="font-size: 0.7rem; padding: 0.25rem 0.5rem"
                                                title="Удалить пользователя">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %} {% else %}
                                <tr style="background: var(--dp-02); color: var(--text-primary)">
                                    <td colspan="8" class="text-center text-muted py-4"
                                        style="color: var(--text-primary)">
                                        <i class="fas fa-users fa-2x mb-3"></i>
                                        <p>Нет пользователей</p>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для массового назначения группы -->
<div class="modal fade" id="massGroupModal" tabindex="-1" aria-labelledby="massGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="massGroupModalLabel">Назначить группу пользователям</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="post" id="mass-group-form">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="action" value="mass_group" />
                    <div id="selected-users-inputs"></div>

                    <div class="mb-3">
                        <label class="form-label">Выберите группу</label>
                        <select name="group_id" class="form-control" required style="
                                background: var(--dp-01);
                                border: 1px solid var(--border-secondary);
                                color: var(--text-primary);
                                border-radius: 20px;
                            ">
                            <option value="">Без группы</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Назначить группу</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для массового изменения статуса -->
<div class="modal fade" id="massStatusModal" tabindex="-1" aria-labelledby="massStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="massStatusModalLabel">Изменить статус пользователей</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="post" id="mass-status-form">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="action" value="mass_status" />
                    <div id="selected-users-status-inputs"></div>

                    <div class="mb-3">
                        <label class="form-label">Выберите статус</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" value="admin"
                                    id="status_admin" />
                                <label class="form-check-label" for="status_admin">
                                    <span class="badge bg-danger">Администратор</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" value="moderator"
                                    id="status_moderator" />
                                <label class="form-check-label" for="status_moderator">
                                    <span class="badge bg-warning">Модератор</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="status" value="user" id="status_user"
                                    checked />
                                <label class="form-check-label" for="status_user">
                                    <span class="badge bg-secondary">Пользователь</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Изменить статус</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для изменения группы отдельного пользователя -->
<div class="modal fade" id="changeGroupModal" tabindex="-1" aria-labelledby="changeGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeGroupModalLabel">Изменить группу</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="post" id="change-group-form">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="change_group_user_id" id="change_group_user_id" />
                    <div class="mb-3">
                        <label class="form-label">Выберите группу</label>
                        <select name="new_group_id" class="form-control" style="
                                background: var(--dp-01);
                                border: 1px solid var(--border-secondary);
                                color: var(--text-primary);
                                border-radius: 20px;
                            ">
                            <option value="">Без группы</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для изменения статуса отдельного пользователя -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-labelledby="changeStatusModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeStatusModalLabel">Изменить статус</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="post" id="change-status-form">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="change_status_user_id" id="change_status_user_id" />
                    <div class="mb-3">
                        <label class="form-label">Выберите статус</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="new_role" value="admin"
                                    id="new_role_admin" />
                                <label class="form-check-label" for="new_role_admin">
                                    <span class="badge bg-danger">Администратор</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="new_role" value="moderator"
                                    id="new_role_moderator" />
                                <label class="form-check-label" for="new_role_moderator">
                                    <span class="badge bg-warning">Модератор</span>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="new_role" value="user"
                                    id="new_role_user" checked />
                                <label class="form-check-label" for="new_role_user">
                                    <span class="badge bg-secondary">Пользователь</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования данных пользователя -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Редактировать данные пользователя</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="post" id="edit-user-form">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <input type="hidden" name="edit_user_id" id="edit_user_id" />

                    <div class="mb-3">
                        <label class="form-label">ID пользователя</label>
                        <input type="text" class="form-control" id="edit_user_id_display" readonly style="
                                background: var(--dp-01);
                                border: 1px solid var(--border-secondary);
                                color: var(--text-primary);
                                border-radius: 20px;
                            " />
                        <small class="text-muted">ID нельзя изменить</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Имя пользователя</label>
                        <input type="text" name="new_username" id="edit_username" class="form-control" required style="
                                background: var(--dp-01);
                                border: 1px solid var(--border-secondary);
                                color: var(--text-primary);
                                border-radius: 20px;
                            " />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Контакт (Email или Telegram ID)</label>
                        <input type="text" name="new_email" id="edit_email" class="form-control" style="
                                background: var(--dp-01);
                                border: 1px solid var(--border-secondary);
                                color: var(--text-primary);
                                border-radius: 20px;
                            " />
                        <small class="text-muted">Для Telegram укажите ID в формате: 123456789@telegram.org</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %} {% block head %}
<style>
    /* Стили для input элементов на странице users */
    .admin-users input {
        margin-left: 15px;
    }
</style>
<script>
    let currentSortColumn = null
    let currentSortDirection = 'asc'

    document.addEventListener('DOMContentLoaded', function () {
        // Улучшение работы с select элементами
        const selects = document.querySelectorAll('select')

        selects.forEach((select) => {
            select.style.cssText =
                'background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 20px;'
        })

        // Улучшение UX для модальных окон
        const modals = document.querySelectorAll('.modal')
        modals.forEach((modal) => {
            modal.addEventListener('shown.bs.modal', function () {
                const firstInput = this.querySelector('input, select')
                if (firstInput) {
                    firstInput.focus()
                }
            })
        })

        // Обработчики для кнопок действий
        document.addEventListener('click', function (e) {
            if (e.target.closest('.reset-password-btn')) {
                const btn = e.target.closest('.reset-password-btn')
                const userId = btn.dataset.userId
                const username = btn.dataset.username
                resetPassword(userId, username)
            } else if (e.target.closest('.change-group-btn')) {
                const btn = e.target.closest('.change-group-btn')
                const userId = btn.dataset.userId
                const currentGroup = btn.dataset.currentGroup
                changeUserGroup(userId, currentGroup)
            } else if (e.target.closest('.change-status-btn')) {
                const btn = e.target.closest('.change-status-btn')
                const userId = btn.dataset.userId
                const currentStatus = btn.dataset.currentStatus
                changeUserStatus(userId, currentStatus)
            } else if (e.target.closest('.toggle-subscription-btn')) {
                const btn = e.target.closest('.toggle-subscription-btn')
                const userId = btn.dataset.userId
                const username = btn.dataset.username
                const hasSubscription = btn.dataset.hasSubscription === 'true'
                toggleSubscription(userId, username, hasSubscription)
            } else if (e.target.closest('.edit-user-btn')) {
                const btn = e.target.closest('.edit-user-btn')
                const userId = btn.dataset.userId
                const username = btn.dataset.username
                const email = btn.dataset.email
                editUser(userId, username, email)
            } else if (e.target.closest('.delete-user-btn')) {
                const btn = e.target.closest('.delete-user-btn')
                const userId = btn.dataset.userId
                const username = btn.dataset.username
                deleteUser(userId, username)
            }
        })
    })

    // Функции для массовых операций
    function selectAllUsers() {
        const checkboxes = document.querySelectorAll('.user-checkbox')
        checkboxes.forEach((checkbox) => (checkbox.checked = true))
        updateSelectedCount()
    }

    function deselectAllUsers() {
        const checkboxes = document.querySelectorAll('.user-checkbox')
        checkboxes.forEach((checkbox) => (checkbox.checked = false))
        updateSelectedCount()
    }

    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('select-all-checkbox')
        const checkboxes = document.querySelectorAll('.user-checkbox')

        checkboxes.forEach((checkbox) => {
            checkbox.checked = selectAllCheckbox.checked
        })
        updateSelectedCount()
    }

    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked')
        const count = checkboxes.length
        const countElement = document.getElementById('selected-count')
        const massGroupBtn = document.getElementById('mass-group-btn')
        const massStatusBtn = document.getElementById('mass-status-btn')
        const massDeleteBtn = document.getElementById('mass-delete-btn')
        const selectAllCheckbox = document.getElementById('select-all-checkbox')

        countElement.textContent = `Выбрано: ${count}`

        // Включаем/выключаем кнопки массовых операций
        massGroupBtn.disabled = count === 0
        massStatusBtn.disabled = count === 0
        massDeleteBtn.disabled = count === 0

        // Обновляем состояние главного чекбокса
        const allCheckboxes = document.querySelectorAll('.user-checkbox')
        if (count === 0) {
            selectAllCheckbox.indeterminate = false
            selectAllCheckbox.checked = false
        } else if (count === allCheckboxes.length) {
            selectAllCheckbox.indeterminate = false
            selectAllCheckbox.checked = true
        } else {
            selectAllCheckbox.indeterminate = true
        }
    }

    function showMassGroupModal() {
        const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked')
        if (selectedCheckboxes.length === 0) {
            alert('Выберите пользователей для назначения группы')
            return
        }

        // Заполняем скрытые поля с выбранными пользователями
        const inputsContainer = document.getElementById('selected-users-inputs')
        inputsContainer.innerHTML = ''

        selectedCheckboxes.forEach((checkbox) => {
            const input = document.createElement('input')
            input.type = 'hidden'
            input.name = 'user_ids'
            input.value = checkbox.value
            inputsContainer.appendChild(input)
        })

        // Показываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('massGroupModal'))
        modal.show()
    }

    function showMassStatusModal() {
        const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked')
        if (selectedCheckboxes.length === 0) {
            alert('Выберите пользователей для изменения статуса')
            return
        }

        // Заполняем скрытые поля с выбранными пользователями
        const inputsContainer = document.getElementById('selected-users-status-inputs')
        inputsContainer.innerHTML = ''

        selectedCheckboxes.forEach((checkbox) => {
            const input = document.createElement('input')
            input.type = 'hidden'
            input.name = 'user_ids'
            input.value = checkbox.value
            inputsContainer.appendChild(input)
        })

        // Показываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('massStatusModal'))
        modal.show()
    }

    function deleteSelectedUsers() {
        const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked')
        if (selectedCheckboxes.length === 0) {
            alert('Выберите пользователей для удаления')
            return
        }

        customConfirm(`Удалить ${selectedCheckboxes.length} пользователей? Это действие нельзя отменить!`, function () {
            // Подтверждение - продолжаем удаление
            const form = document.createElement('form')
            form.method = 'post'
            form.style.display = 'none'

            const csrfInput = document.createElement('input')
            csrfInput.type = 'hidden'
            csrfInput.name = 'csrf_token'
            csrfInput.value = document.querySelector('input[name="csrf_token"]').value
            form.appendChild(csrfInput)

            const actionInput = document.createElement('input')
            actionInput.type = 'hidden'
            actionInput.name = 'action'
            actionInput.value = 'mass_delete'
            form.appendChild(actionInput)

            selectedCheckboxes.forEach((checkbox) => {
                const input = document.createElement('input')
                input.type = 'hidden'
                input.name = 'user_ids'
                input.value = checkbox.value
                form.appendChild(input)
            })

            document.body.appendChild(form)
            form.submit()
        })
        return

        // Создаем форму для массового удаления
        const form = document.createElement('form')
        form.method = 'post'
        form.style.display = 'none'

        // Добавляем CSRF токен
        const csrfInput = document.createElement('input')
        csrfInput.type = 'hidden'
        csrfInput.name = 'csrf_token'
        csrfInput.value = document.querySelector('input[name="csrf_token"]').value
        form.appendChild(csrfInput)

        // Добавляем действие
        const actionInput = document.createElement('input')
        actionInput.type = 'hidden'
        actionInput.name = 'action'
        actionInput.value = 'mass_delete'
        form.appendChild(actionInput)

        // Добавляем выбранных пользователей
        selectedCheckboxes.forEach((checkbox) => {
            const input = document.createElement('input')
            input.type = 'hidden'
            input.name = 'user_ids'
            input.value = checkbox.value
            form.appendChild(input)
        })

        document.body.appendChild(form)
        form.submit()
    }

    // Функции для отдельных пользователей
    function resetPassword(userId, username) {
        customConfirm(`Сбросить пароль для пользователя ${username}?`, function () {
            // Подтверждение - продолжаем сброс пароля

            const formData = new FormData()
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value)
            formData.append('reset_user_id', userId)

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
            })
                .then((response) => response.text())
                .then((html) => {
                    // Парсим HTML ответ для поиска нового пароля
                    const parser = new DOMParser()
                    const doc = parser.parseFromString(html, 'text/html')

                    // Ищем элемент с новым паролем (если он есть в password_map)
                    const passwordElement = doc.querySelector(`[data-password-for="${userId}"]`)

                    if (passwordElement) {
                        const newPassword = passwordElement.dataset.password
                        showPasswordNotification(username, newPassword)
                    } else {
                        // Если не нашли в password_map, просто перезагружаем
                        window.showSuccess('Пароль сброшен')
                        setTimeout(() => location.reload(), 1500)
                    }
                })
                .catch((error) => {
                    console.error('Ошибка AJAX:', error)
                    window.showError('Ошибка при сбросе пароля')
                })
        })
    }

    function showPasswordNotification(username, password) {
        if (!window.notificationManager) {
            alert(`Пароль для ${username}: ${password}`)
            location.reload()
            return
        }

        // Создаем HTML для уведомления с паролем
        const notificationContent = `
        <div style="max-width: 350px;">
            <div style="font-weight: 600; margin-bottom: 8px;">
                Пароль для пользователя ${username} сброшен
            </div>
            <div style="background: var(--dp-04); padding: 10px; border-radius: 8px; margin-bottom: 10px; font-family: monospace; word-break: break-all; font-size: 14px;">
                ${password}
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="copyPasswordToClipboard('${password}')" style="font-size: 12px; padding: 4px 12px;">
                <i class="fas fa-copy me-1"></i>Копировать пароль
            </button>
            <div style="margin-top: 8px; font-size: 11px; color: var(--text-secondary);">
                <i class="fas fa-exclamation-triangle me-1"></i>Сохраните пароль! Он больше не будет показан.
            </div>
        </div>
    `

        // Показываем уведомление с увеличенным временем (30 секунд)
        window.notificationManager.show(notificationContent, 'success', 30000)

        // Перезагружаем страницу после закрытия через 31 секунду
        setTimeout(() => {
            location.reload()
        }, 31000)
    }

    function copyPasswordToClipboard(password) {
        // Создаем временный input для копирования
        const tempInput = document.createElement('input')
        tempInput.value = password
        tempInput.style.position = 'absolute'
        tempInput.style.left = '-9999px'
        document.body.appendChild(tempInput)

        tempInput.select()
        tempInput.setSelectionRange(0, 99999)

        try {
            document.execCommand('copy')
            showSuccess('Пароль скопирован в буфер обмена')
        } catch (err) {
            console.error('Ошибка копирования:', err)
            // Пробуем современный API
            navigator.clipboard
                .writeText(password)
                .then(() => {
                    showSuccess('Пароль скопирован в буфер обмена')
                })
                .catch((err) => {
                    showError('Не удалось скопировать пароль')
                })
        }

        document.body.removeChild(tempInput)
    }

    function changeUserGroup(userId, currentGroup) {
        document.getElementById('change_group_user_id').value = userId

        // Устанавливаем текущую группу
        const select = document.querySelector('#changeGroupModal select')
        const options = select.querySelectorAll('option')
        options.forEach((option) => {
            option.selected = option.textContent === currentGroup
        })

        const modal = new bootstrap.Modal(document.getElementById('changeGroupModal'))
        modal.show()
    }

    function changeUserStatus(userId, currentStatus) {
        document.getElementById('change_status_user_id').value = userId

        // Устанавливаем текущий статус
        const radios = document.querySelectorAll('#changeStatusModal input[name="new_role"]')
        radios.forEach((radio) => {
            radio.checked = radio.value === currentStatus
        })

        const modal = new bootstrap.Modal(document.getElementById('changeStatusModal'))
        modal.show()
    }

    function toggleSubscription(userId, username, hasSubscription) {
        const action = hasSubscription ? 'отозвать' : 'выдать'
        const actionCapitalized = action.charAt(0).toUpperCase() + action.slice(1)

        customConfirm(`${actionCapitalized} подписку пользователю ${username}?`, function () {
            // Подтверждение - продолжаем

            const form = document.createElement('form')
            form.method = 'post'
            form.style.display = 'none'

            const csrfInput = document.createElement('input')
            csrfInput.type = 'hidden'
            csrfInput.name = 'csrf_token'
            csrfInput.value = document.querySelector('input[name="csrf_token"]').value
            form.appendChild(csrfInput)

            const userIdInput = document.createElement('input')
            userIdInput.type = 'hidden'
            userIdInput.name = 'toggle_subscription_id'
            userIdInput.value = userId
            form.appendChild(userIdInput)

            document.body.appendChild(form)
            form.submit()
        })
    }

    function editUser(userId, username, email) {
        document.getElementById('edit_user_id').value = userId
        document.getElementById('edit_user_id_display').value = userId
        document.getElementById('edit_username').value = username
        document.getElementById('edit_email').value = email

        const modal = new bootstrap.Modal(document.getElementById('editUserModal'))
        modal.show()
    }

    function deleteUser(userId, username) {
        customConfirm(`Удалить пользователя ${username}? Это действие нельзя отменить!`, function () {
            // Подтверждение - продолжаем удаление
            const form = document.createElement('form')
            form.method = 'post'
            form.style.display = 'none'

            const csrfInput = document.createElement('input')
            csrfInput.type = 'hidden'
            csrfInput.name = 'csrf_token'
            csrfInput.value = document.querySelector('input[name="csrf_token"]').value
            form.appendChild(csrfInput)

            const userIdInput = document.createElement('input')
            userIdInput.type = 'hidden'
            userIdInput.name = 'delete_user_id'
            userIdInput.value = userId
            form.appendChild(userIdInput)

            document.body.appendChild(form)
            form.submit()
        })
    }

    // Функции сортировки
    function sortTable(column) {
        const tbody = document.getElementById('users-table-body')
        const rows = Array.from(tbody.querySelectorAll('tr'))

        // Определяем направление сортировки
        if (currentSortColumn === column) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc'
        } else {
            currentSortDirection = 'asc'
            currentSortColumn = column
        }

        // Сортируем строки
        rows.sort((a, b) => {
            let aValue, bValue

            switch (column) {
                case 'id':
                    aValue = parseInt(a.querySelector('td:nth-child(2) .badge').textContent)
                    bValue = parseInt(b.querySelector('td:nth-child(2) .badge').textContent)
                    break
                case 'username':
                    aValue = a.querySelector('td:nth-child(3) strong').textContent.toLowerCase()
                    bValue = b.querySelector('td:nth-child(3) strong').textContent.toLowerCase()
                    break
                case 'contact':
                    const aContact = a.querySelector('td:nth-child(4) span').textContent.toLowerCase()
                    const bContact = b.querySelector('td:nth-child(4) span').textContent.toLowerCase()
                    aValue = aContact.includes('не указан') ? 'zzz' : aContact
                    bValue = bContact.includes('не указан') ? 'zzz' : bContact
                    break
                case 'group':
                    const aGroup = a.querySelector('td:nth-child(5)').textContent.toLowerCase()
                    const bGroup = b.querySelector('td:nth-child(5)').textContent.toLowerCase()
                    aValue = aGroup.includes('без группы') ? 'zzz' : aGroup
                    bValue = bGroup.includes('без группы') ? 'zzz' : bGroup
                    break
                case 'status':
                    const aStatus = a.querySelector('td:nth-child(6) .badge').textContent.toLowerCase()
                    const bStatus = b.querySelector('td:nth-child(6) .badge').textContent.toLowerCase()
                    const statusOrder = { админ: 0, модератор: 1, пользователь: 2 }
                    aValue = statusOrder[aStatus] || 3
                    bValue = statusOrder[bStatus] || 3
                    break
                case 'subscription':
                    const aSub = a.querySelector('td:nth-child(7) .badge').classList.contains('bg-success')
                    const bSub = b.querySelector('td:nth-child(7) .badge').classList.contains('bg-success')
                    aValue = aSub ? 0 : 1
                    bValue = bSub ? 0 : 1
                    break
                default:
                    return 0
            }

            if (aValue < bValue) return currentSortDirection === 'asc' ? -1 : 1
            if (aValue > bValue) return currentSortDirection === 'asc' ? 1 : -1
            return 0
        })

        // Очищаем tbody и добавляем отсортированные строки
        tbody.innerHTML = ''
        rows.forEach((row) => tbody.appendChild(row))

        // Обновляем иконки сортировки
        updateSortIcons(column)
    }

    function updateSortIcons(activeColumn) {
        // Сбрасываем все иконки
        document.querySelectorAll('th button i').forEach((icon) => {
            icon.className = 'fas fa-sort ms-1'
        })

        // Устанавливаем иконку для активной колонки
        const activeButton = document.querySelector(`button[onclick="sortTable('${activeColumn}')"]`)
        if (activeButton) {
            const icon = activeButton.querySelector('i')
            icon.className = currentSortDirection === 'asc' ? 'fas fa-sort-up ms-1' : 'fas fa-sort-down ms-1'
        }
    }

    // Функция копирования в буфер обмена
    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard
                .writeText(text)
                .then(function () {
                    showNotification('Скопировано: ' + text, 'success')
                })
                .catch(function (err) {
                    console.error('Ошибка копирования через Clipboard API:', err)
                    fallbackCopyToClipboard(text)
                })
        } else {
            fallbackCopyToClipboard(text)
        }
    }

    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea')
        textArea.value = text
        textArea.style.position = 'fixed'
        textArea.style.left = '-999999px'
        textArea.style.top = '-999999px'
        document.body.appendChild(textArea)
        textArea.focus()
        textArea.select()

        try {
            const successful = document.execCommand('copy')
            if (successful) {
                showNotification('Скопировано: ' + text, 'success')
            } else {
                showNotification('Ошибка копирования', 'error')
            }
        } catch (err) {
            console.error('Ошибка fallback копирования:', err)
            showNotification('Ошибка копирования', 'error')
        } finally {
            document.body.removeChild(textArea)
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div')
        notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'
            } alert-dismissible fade show`
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;'
        notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `

        document.body.appendChild(notification)

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove()
            }
        }, 3000)
    }

    function openTelegram(telegramId) {
        const tgUrl = `tg://user?id=${telegramId}`
        window.open(tgUrl, '_blank')
        showNotification('Открываем Telegram...', 'info')
    }
</script>
{% endblock %}