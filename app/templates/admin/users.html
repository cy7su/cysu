{% extends 'base.html' %}
{% block title %}Админка: Управление пользователями{% endblock %}

{% block content %}
<div class="admin-users">
<div class="container-fluid">
  <!-- Заголовок -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Управление пользователями</h2>
    <span class="badge bg-primary fs-6">{{ users|length }} пользователей</span>
  </div>

  <div class="row g-4">
    <!-- Создание пользователя -->
    <div class="col-lg-3">
      <div class="card shadow-sm border-0" style="background: var(--dp-02); height: fit-content;">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="fas fa-user-plus me-2 text-primary"></i>Создать пользователя
          </h5>
          <form method="post">
            {{ form.hidden_tag() }}
            <div class="mb-3">
              <label for="{{ form.username.id }}" class="form-label">Имя пользователя</label>
              {{ form.username(class_='form-control', placeholder='Введите имя пользователя') }}
              {% if form.username.errors %}
                <div class="text-danger small">
                  {% for error in form.username.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label for="{{ form.email.id }}" class="form-label">Email</label>
              {{ form.email(class_='form-control', placeholder='Введите email') }}
              {% if form.email.errors %}
                <div class="text-danger small">
                  {% for error in form.email.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label for="{{ form.password.id }}" class="form-label">Пароль</label>
                              {{ form.password(class_='form-control', placeholder='Введите пароль', style='background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 20px;') }}
              {% if form.password.errors %}
                <div class="text-danger small">
                  {% for error in form.password.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label for="{{ form.confirm_password.id }}" class="form-label">Подтвердите пароль</label>
                              {{ form.confirm_password(class_='form-control', placeholder='Подтвердите пароль', style='background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 20px;') }}
              {% if form.confirm_password.errors %}
                <div class="text-danger small">
                  {% for error in form.confirm_password.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="mb-3">
              <label for="{{ form.group_id.id }}" class="form-label">Группа</label>
                              {{ form.group_id(class_='form-control', style='background: var(--dp-01); border: 1px solid var(--border-secondary); color: var(--text-primary); border-radius: 20px;') }}
              {% if form.group_id.errors %}
                <div class="text-danger small">
                  {% for error in form.group_id.errors %}
                    {{ error }}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            
            <!-- Роли пользователя -->
            <div class="mb-3">
              <label class="form-label">Роли</label>
              <div class="form-check">
                {{ form.is_admin(class_='form-check-input') }}
                <label class="form-check-label" for="{{ form.is_admin.id }}">
                  Администратор
                </label>
              </div>
              <div class="form-check">
                {{ form.is_moderator(class_='form-check-input') }}
                <label class="form-check-label" for="{{ form.is_moderator.id }}">
                  Модератор
                </label>
              </div>
            </div>
            
            <button type="submit" name="submit" value="Зарегистрироваться" class="btn btn-primary w-100">
              <i class="fas fa-plus me-2"></i>Создать пользователя
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Список пользователей -->
    <div class="col-lg-9">
      <div class="card shadow-sm border-0" style="background: var(--dp-02);">
        <div class="card-body p-0">
          <div class="table-responsive" style="border-radius: 14px;">
            <table class="table mb-0" style="background: var(--dp-02); color: var(--text-primary); font-size: 0.9em;">
              <thead style="background: var(--dp-03);">
                <tr>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">ID</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Пользователь</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Email</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Группа</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Статус</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Подписка</th>
                  <th class="border-0" style="color: var(--text-primary); font-size: 0.9em; padding: 0.5rem;">Действия</th>
                </tr>
              </thead>
              <tbody style="background: var(--dp-02);">
                {% for user in users %}
                <tr style="border-color: var(--border-secondary); background: var(--dp-02); color: var(--text-primary);">
                  <td><span class="badge bg-secondary">{{ user.id }}</span></td>
                  <td>
                    <strong>{{ user.username }}</strong>
                    {% if user.id == current_user.id %}
                      <span class="badge bg-warning text-dark ms-1">Вы</span>
                    {% endif %}
                  </td>
                  <td>
                    <small class="text-muted">{{ user.email }}</small>
                  </td>
                  <td>
                    {% if user.group %}
                      <span class="badge bg-primary">{{ user.group.name }}</span>
                      <button type="button" class="btn btn-sm btn-outline-primary ms-1" 
                              data-bs-toggle="modal" 
                              data-bs-target="#changeGroupModal{{ user.id }}">
                        <i class="fas fa-edit"></i>
                      </button>
                    {% else %}
                      <span class="text-muted">Не назначена</span>
                      <button type="button" class="btn btn-sm btn-outline-warning ms-1" 
                              data-bs-toggle="modal" 
                              data-bs-target="#changeGroupModal{{ user.id }}">
                        <i class="fas fa-plus"></i>
                      </button>
                    {% endif %}
                  </td>
                  <td>
                    {% if user.is_admin %}
                      <span class="badge bg-danger">Админ</span>
                      {% if user.admin_mode_enabled %}
                        <span class="badge bg-success ms-1">Админ режим</span>
                      {% else %}
                        <span class="badge bg-secondary ms-1">Пользователь режим</span>
                      {% endif %}
                    {% elif user.is_moderator %}
                      <span class="badge bg-warning">Модератор</span>
                    {% else %}
                      <span class="badge bg-secondary">Пользователь</span>
                    {% endif %}
                    
                    <!-- Кнопка редактирования статуса -->
                    {% if user.id != current_user.id %}
                      <button type="button" class="btn btn-sm btn-outline-primary ms-1" 
                              data-bs-toggle="modal" 
                              data-bs-target="#changeStatusModal{{ user.id }}">
                        <i class="fas fa-edit"></i>
                      </button>
                    {% endif %}
                  </td>
                  <td>
                    {% if user.has_active_subscription() %}
                      {% if user.is_trial_subscription %}
                        {% if user.trial_subscription_expires %}
                          <span class="badge bg-info">
                            <i class="fas fa-clock me-1"></i>
                            Пробная до {{ user.trial_subscription_expires.strftime('%d.%m.%Y') }}
                          </span>
                        {% else %}
                          <span class="badge bg-info">Пробная активна</span>
                        {% endif %}
                      {% elif user.subscription_expires %}
                        <span class="badge bg-success">
                          <i class="fas fa-check me-1"></i>
                          До {{ user.subscription_expires.strftime('%d.%m.%Y') }}
                        </span>
                      {% else %}
                        <span class="badge bg-success">Активна</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-warning text-dark">Нет подписки</span>
                    {% endif %}
                  </td>
                <td>
                    <div class="d-grid">
                      <!-- Показать новый пароль -->
                      {% if password_map.get(user.id) %}
                        <button type="button" class="btn btn-info" 
                                data-bs-toggle="tooltip" 
                                title="Новый пароль: {{ password_map.get(user.id) }}. Кликните для копирования." 
                                onclick="copyPassword('{{ password_map.get(user.id) }}')">
                          <i class="fas fa-key"></i>
                        </button>
                      {% else %}
                        <!-- Сброс пароля -->
                        <form method="post">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="reset_user_id" value="{{ user.id }}">
                          <button type="submit" class="btn btn-warning" data-bs-toggle="tooltip" title="Сбросить пароль">
                            <i class="fas fa-key"></i>
                          </button>
                        </form>
                      {% endif %}
                      
                      <!-- Изменение статуса администратора -->
                      {% if user.id != current_user.id %}
                        <form method="post">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="toggle_admin_id" value="{{ user.id }}">
                          <button type="submit" class="btn {% if user.is_admin %}btn-danger{% else %}btn-primary{% endif %}" 
                                  data-bs-toggle="tooltip" 
                                  title="{% if user.is_admin %}Снять админку{% else %}Назначить админом{% endif %}">
                            <i class="fas fa-user-shield"></i>
                          </button>
                        </form>
                      {% endif %}
                      
                      <!-- Управление подпиской -->
                      <form method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="toggle_subscription_id" value="{{ user.id }}">
                        <button type="submit" class="btn {% if user.has_active_subscription() %}btn-warning{% else %}btn-success{% endif %}" 
                                data-bs-toggle="tooltip" 
                                title="{% if user.has_active_subscription() %}Отозвать подписку{% else %}Выдать подписку{% endif %}">
                          <i class="fas fa-crown"></i>
                        </button>
                      </form>
                      
                      <!-- Удаление пользователя -->
                      {% if not user.is_admin and user.id != current_user.id %}
                        <form method="post" onsubmit="return confirm('Удалить пользователя {{ user.username }}?')">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                          <input type="hidden" name="delete_user_id" value="{{ user.id }}">
                          <button type="submit" class="btn btn-danger" data-bs-toggle="tooltip" title="Удалить пользователя">
                            <i class="fas fa-trash"></i>
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% else %}
                  <tr style="background: var(--dp-02); color: var(--text-primary);">
                    <td colspan="7" class="text-center text-muted py-4" style="color: var(--text-primary);">
                      <i class="fas fa-users fa-2x mb-3"></i>
                      <p>Нет пользователей</p>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>



<!-- Блок управления короткими ссылками удален -->

<!-- Таблица ссылок удалена -->

<!-- Убраны старые inline стили - теперь используется admin.css -->

<script>
// Инициализация tooltips
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  })
  
  // Функциональность коротких ссылок удалена
});

// Функция для копирования пароля в буфер обмена
function copyPassword(password) {
  // Создаем временный элемент input
  const tempInput = document.createElement('input');
  tempInput.value = password;
  document.body.appendChild(tempInput);
  
  // Выделяем и копируем текст
  tempInput.select();
  tempInput.setSelectionRange(0, 99999); // Для мобильных устройств
  
  try {
    // Пытаемся использовать современный Clipboard API
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(password).then(function() {
        showCopyNotification('Пароль скопирован!');
      }).catch(function(err) {
        // Fallback для старых браузеров
        fallbackCopyTextToClipboard(password);
      });
    } else {
      // Fallback для старых браузеров
      fallbackCopyTextToClipboard(password);
    }
  } catch (err) {
    // Fallback для старых браузеров
    fallbackCopyTextToClipboard(password);
  }
  
  // Удаляем временный элемент
  document.body.removeChild(tempInput);
}

// Fallback функция для копирования в старых браузерах
function fallbackCopyTextToClipboard(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.top = '0';
  textArea.style.left = '0';
  textArea.style.position = 'fixed';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      showCopyNotification('Пароль скопирован!');
    } else {
      showCopyNotification('Ошибка копирования', 'error');
    }
  } catch (err) {
    showCopyNotification('Ошибка копирования', 'error');
  }
  
  document.body.removeChild(textArea);
}

// Функция для показа уведомления о копировании
function showCopyNotification(message, type = 'success') {
  // Создаем элемент уведомления
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
  notification.style.cssText = `
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 200px;
    padding: 10px 15px;
    border-radius: 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    animation: slideIn 0.3s ease-out;
  `;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'} me-2"></i>
    ${message}
  `;
  
  // Добавляем стили для анимации
  if (!document.getElementById('copy-notification-styles')) {
    const style = document.createElement('style');
    style.id = 'copy-notification-styles';
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  }
  
  // Добавляем уведомление на страницу
  document.body.appendChild(notification);
  
  // Удаляем уведомление через 3 секунды
  setTimeout(function() {
    notification.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(function() {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}
</script>

<!-- Модальные окна для изменения группы пользователя -->
{% for user in users %}
<div class="modal fade" id="changeGroupModal{{ user.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Изменить группу пользователя {{ user.username }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post">
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="change_group_user_id" value="{{ user.id }}">
          <div class="mb-3">
            <label class="form-label">Выберите группу</label>
            <select name="new_group_id" class="form-control" required>
              <option value="">Без группы</option>
              {% for group in groups %}
                <option value="{{ group.id }}" 
                        {% if user.group and user.group.id == group.id %}selected{% endif %}>
                  {{ group.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Сохранить</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Модальное окно для изменения статуса пользователя -->
<div class="modal fade" id="changeStatusModal{{ user.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Изменить статус пользователя {{ user.username }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post">
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="change_status_user_id" value="{{ user.id }}">
          
          <div class="mb-3">
            <label class="form-label">Выберите роль</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="new_role" value="user" id="role_user_{{ user.id }}"
                     {% if not user.is_admin and not user.is_moderator %}checked{% endif %}>
              <label class="form-check-label" for="role_user_{{ user.id }}">
                <span class="badge bg-secondary">Пользователь</span>
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="new_role" value="moderator" id="role_moderator_{{ user.id }}"
                     {% if user.is_moderator %}checked{% endif %}>
              <label class="form-check-label" for="role_moderator_{{ user.id }}">
                <span class="badge bg-warning">Модератор</span>
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="new_role" value="admin" id="role_admin_{{ user.id }}"
                     {% if user.is_admin %}checked{% endif %}>
              <label class="form-check-label" for="role_admin_{{ user.id }}">
                <span class="badge bg-danger">Администратор</span>
              </label>
            </div>
          </div>
          
          <!-- Дополнительные настройки для Админа -->
          <div id="admin_settings_{{ user.id }}" style="display: none;">
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="admin_mode_enabled" id="admin_mode_{{ user.id }}"
                       {% if user.admin_mode_enabled %}checked{% endif %}>
                <label class="form-check-label" for="admin_mode_{{ user.id }}">
                  Включить админ режим
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Сохранить</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<script>
// Показываем/скрываем настройки Админа в зависимости от выбранной роли
document.addEventListener('DOMContentLoaded', function() {
  {% for user in users %}
  const adminRadio{{ user.id }} = document.getElementById('role_admin_{{ user.id }}');
  const adminSettings{{ user.id }} = document.getElementById('admin_settings_{{ user.id }}');
  
  function toggleAdminSettings{{ user.id }}() {
    if (adminRadio{{ user.id }}.checked) {
      adminSettings{{ user.id }}.style.display = 'block';
    } else {
      adminSettings{{ user.id }}.style.display = 'none';
    }
  }
  
  // Инициализация
  toggleAdminSettings{{ user.id }}();
  
  // Обработчик изменения
  adminRadio{{ user.id }}.addEventListener('change', toggleAdminSettings{{ user.id }});
  
  // Обработчики для других ролей
  document.getElementById('role_user_{{ user.id }}').addEventListener('change', toggleAdminSettings{{ user.id }});
  document.getElementById('role_moderator_{{ user.id }}').addEventListener('change', toggleAdminSettings{{ user.id }});
  {% endfor %}
});
</script>

{% endblock %} 