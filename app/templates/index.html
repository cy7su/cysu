{% extends 'base.html' %}
{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}
{% block content %}

{% if not current_user.is_authenticated %}
<!-- –°–µ–∫—Ü–∏—è –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<section class="hero-container" style="min-height: calc(100vh - 200px); display: flex; align-items: center; justify-content: center;">
    <div class="container">
        <header class="text-center">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="mb-5">
                <h1 class="display-5 fw-bold text-white mb-3">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ cysu</h1>
                <p class="text-muted">–î–õ–Ø –í–°–ï–• –¢–ï–• –ö–¢–û –ù–ï–ù–ê–í–ò–î–ò–¢ MOODLE</p>
            </div>
            
            <!-- –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ -->
            <section class="row g-3 justify-content-center mb-4">
                <div class="col-md-4">
                    <div class="quick-feature p-3" style="background: var(--dp-02); border: 1px solid var(--border-secondary); border-radius: 12px;">
                        <i class="fas fa-book text-primary mb-2"></i>
                        <h6 class="text-primary mb-1">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h6>
                        <small class="text-muted">–í—ã–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="quick-feature p-3" style="background: var(--dp-02); border: 1px solid var(--border-secondary); border-radius: 12px;">
                        <i class="fas fa-code text-primary mb-2"></i>
                        <h6 class="text-primary mb-1">–ü—Ä–∞–∫—Ç–∏–∫–∞</h6>
                        <small class="text-muted">–ó–∞–≥—Ä—É–∂–∞–π —Ä–µ—à–µ–Ω–∏—è, –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="quick-feature p-3" style="background: var(--dp-02); border: 1px solid var(--border-secondary); border-radius: 12px;">
                        <i class="fas fa-comments text-primary mb-2"></i>
                        <h6 class="text-primary mb-1">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h6>
                        <small class="text-muted">–ß–∞—Ç –∏ —Ç–∏–∫–µ—Ç—ã - —Ä–µ—à–∞—Ç –≤—Å–µ —Ç–≤–æ–∏ –ø—Ä–æ–±–ª–µ–º—ã</small>
                    </div>
                </div>
            </section>
            
            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <nav class="d-flex gap-2 justify-content-center flex-wrap">
                <a href="{{ url_for('auth.register') }}" class="btn btn-primary btn-sm px-3">
                    –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </a>
                <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary btn-sm px-3">
                    –í–æ–π—Ç–∏
                </a>
            </nav>
        </header>
    </div>
</section>

<style>
.quick-feature {
    transition: all 0.2s ease;
}
.quick-feature:hover {
    border-color: var(--primary-color) !important;
    transform: translateY(-2px);
}
</style>

{% else %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
  <div class="d-flex align-items-center">
    <h2 class="mb-3 mb-md-0">–ü—Ä–µ–¥–º–µ—Ç—ã</h2>
    {% if current_user.is_authenticated and current_user.is_admin %}
    <div class="mode-switch">
      <form method="post" action="{{ url_for('main.toggle_admin_mode') }}" style="display: inline;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label class="mode-toggle">
          <input type="checkbox" {% if current_user.admin_mode_enabled %}checked{% endif %} onchange="this.form.submit()">
          <span class="mode-slider"></span>
        </label>

      </form>
    </div>
    {% endif %}
  </div>
  {% if current_user.is_admin and current_user.admin_mode_enabled %}
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addSubjectModal" style="padding: 4px 12px !important; font-size: 0.85rem;">
        <i class="fas fa-plus d-md-none me-1"></i>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç
    </button>
  {% endif %}
</div>
<div class="row g-4" style="column-gap: 110px;">
    {% for subject in subjects %}
    <div class="col-12 col-md-6 col-lg-4 col-xl-3">
        <div class="card shadow-sm subject-card position-relative" id="subject-card-{{ subject.id }}" data-subject-id="{{ subject.id }}" data-url="{{ url_for('main.subject_detail', subject_id=subject.id) }}" onclick="window.location.href=this.getAttribute('data-url')">
            <!-- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
            {% if current_user.is_effective_admin() %}
            <button class="admin-pattern-btn" onclick="event.stopPropagation(); generateNewPattern('subject-card-{{ subject.id }}')" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω">
                <i class="fas fa-palette"></i>
            </button>
            {% endif %}
            
            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å SVG –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º –¥–ª—è —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è 32:10 -->
            <div class="card-img dashboard-card-img pattern-container" data-pattern-type="{{ subject.pattern_type or 'dots' }}" data-pattern-svg="{{ subject.pattern_svg or '' }}">
                <span class="sr-only">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</span>
            </div>
            
            <!-- –¢–µ–º–Ω–æ–µ —Ç–µ–ª–æ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
            <div class="card-body">
                <h6 class="card-title text-primary mb-1">{{ subject.title[:35]|e }}{% if subject.title|length > 35 %}...{% endif %}</h6>
                <p class="card-text text-muted mb-1">{{ subject.description[:70]|e }}{% if subject.description|length > 70 %}...{% endif %}</p>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12"><div class="alert alert-info">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div></div>
    {% endfor %}
</div>
{% if current_user.is_admin and current_user.admin_mode_enabled %}
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞ -->
<div class="modal fade" id="addSubjectModal" tabindex="-1" aria-labelledby="addSubjectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addSubjectModalLabel">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post">
          <div class="modal-body">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="pattern_svg" id="pattern-svg-input" value="">
            <div class="mb-3">
              <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</label>
              <input type="text" name="title" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea name="description" class="form-control" style="min-height: 80px; resize: vertical;"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">–§–æ–Ω –ø—Ä–µ–¥–º–µ—Ç–∞</label>
              <select id="pattern-select" name="pattern_type" class="form-select">
                <option value="circles">–ö—Ä—É–≥–∏</option>
                <option value="hexagons">–®–µ—Å—Ç–∏–≥—Ä–∞–Ω–Ω–∏–∫–∏</option>
                <option value="grid">–°–µ—Ç–∫–∞</option>
                <option value="octagons">–í–æ—Å—å–º–∏—É–≥–æ–ª—å–Ω–∏–∫–∏</option>
                <option value="herringbone">–ï–ª–æ—á–∫–∞</option>
                <option value="quilt">–õ–æ—Å–∫—É—Ç–Ω–æ–µ –æ–¥–µ—è–ª–æ</option>
                <option value="honeycomb">–°–æ—Ç—ã</option>
              </select>
            </div>
            <div class="mb-3">
              <div id="pattern-preview" class="pattern-preview"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
    </div>
  </div>
</div>
{% endif %}
{% endif %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/svg-patterns.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ SVGPatternGenerator
    function initializePatternGenerator() {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
        if (window.patternGenerator && typeof window.patternGenerator.generatePattern === 'function') {
            const generator = window.patternGenerator;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫ –∫–∞—Ä—Ç–æ—á–∫–∞–º –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            applyPatternsToCards(generator);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            initializePatternPreview(generator);
            return;
        }
        
        if (typeof SVGPatternGenerator === 'undefined') {
            // –ü—Ä–æ–±—É–µ–º –µ—â–µ 50 —Ä–∞–∑ (5 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º)
            if (window.patternLoadAttempts === undefined) {
                window.patternLoadAttempts = 0;
            }
            if (window.patternLoadAttempts < 50) {
                window.patternLoadAttempts++;
                setTimeout(initializePatternGenerator, 100);
                return;
            } else {
                useFallbackPatterns();
                return;
            }
        }
        
        try {
            // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
            const generator = new SVGPatternGenerator();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∫ –∫–∞—Ä—Ç–æ—á–∫–∞–º –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            applyPatternsToCards(generator);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            initializePatternPreview(generator);
            
        } catch (error) {
            useFallbackPatterns();
        }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    initializePatternGenerator();
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∫ –∫–∞—Ä—Ç–æ—á–∫–∞–º
    function applyPatternsToCards(generator) {
        const subjectCards = document.querySelectorAll('.dashboard-card-img');
        
        if (subjectCards.length === 0) {
            return;
        }
        
        subjectCards.forEach(function(card, index) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π SVG –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            const savedSvg = card.getAttribute('data-pattern-svg');
            const patternType = card.getAttribute('data-pattern-type');
            
            if (savedSvg && savedSvg.trim() !== '') {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π SVG –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ savedSvg —É–∂–µ base64 –∏–ª–∏ –æ–±—ã—á–Ω—ã–º SVG
                    let svgToUse;
                    if (savedSvg.includes('<svg')) {
                        // –≠—Ç–æ –æ–±—ã—á–Ω—ã–π SVG, –∫–æ–¥–∏—Ä—É–µ–º –≤ base64
                        svgToUse = btoa(unescape(encodeURIComponent(savedSvg)));
                    } else {
                        // –≠—Ç–æ —É–∂–µ base64, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
                        svgToUse = savedSvg;
                    }
                    
                    card.style.backgroundImage = `url("data:image/svg+xml;base64,${svgToUse}")`;
                } catch (error) {
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º SVG, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
                    generateAndApplyPattern(card, generator, index);
                }
            } else {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ
                generateAndApplyPattern(card, generator, index);
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
    window.generateNewPatternForCard = function(cardId) {
        if (typeof window !== 'undefined' && window.patternGenerator) {
            const newPattern = window.patternGenerator.generateRandomPattern();
            const card = document.getElementById(cardId);
            if (card) {
                const patternContainer = card.querySelector('.pattern-container');
                const button = card.querySelector('.admin-pattern-btn');
                
                if (patternContainer) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ
                    if (button) {
                        const originalContent = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        button.disabled = true;
                        
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –º–∞–∫—Å–∏–º—É–º
                        setTimeout(() => {
                            button.innerHTML = originalContent;
                            button.disabled = false;
                        }, 3000);
                    }
                    
                    // –ö–æ–¥–∏—Ä—É–µ–º SVG –≤ base64 –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–∞–∫ background-image
                    const encodedPattern = btoa(unescape(encodeURIComponent(newPattern)));
                    patternContainer.style.backgroundImage = `url("data:image/svg+xml;base64,${encodedPattern}")`;
                    
                    // –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–µ–¥–º–µ—Ç–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
                    const subjectId = card.getAttribute('data-subject-id');
                    if (subjectId) {
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞
                        savePatternToServer(subjectId, newPattern, button);
                    }
                    
                    console.log(`üé® –ù–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ ${cardId}`);
                    return true;
                }
            }
        }
        return false;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    function savePatternToServer(subjectId, patternSvg, button) {
        fetch(`/api/subject/${subjectId}/pattern`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({
                pattern_svg: patternSvg,
                pattern_type: 'random'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                showSuccess('–ü–∞—Ç—Ç–µ—Ä–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 2000);
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞:', data.error);
                showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞: ' + data.error, 3000);
            }
        })
        .catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞:', error);
            showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞', 3000);
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
            if (button) {
                button.innerHTML = '<i class="fas fa-palette"></i>';
                button.disabled = false;
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤)
    function generateAndApplyPattern(card, generator, index) {
        const patternType = card.getAttribute('data-pattern-type') || 'dots';
        
        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ SVG
            const pattern = generator.generatePattern(patternType);
            if (pattern && pattern.includes('<svg')) {
                const encodedPattern = btoa(unescape(encodeURIComponent(pattern)));
                card.style.backgroundImage = `url("data:image/svg+xml;base64,${encodedPattern}")`;
            }
        } catch (error) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ SVG –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–∞
    function generateUniqueSVGForSubject(patternType) {
        if (window.patternGenerator && typeof window.patternGenerator.generatePattern === 'function') {
            try {
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π SVG –∏—Å–ø–æ–ª—å–∑—É—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
                const uniqueSVG = window.patternGenerator.generatePattern(patternType);
                if (uniqueSVG && uniqueSVG.includes('<svg')) {
                    // –ö–æ–¥–∏—Ä—É–µ–º SVG –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ —Ñ–æ—Ä–º—É
                    const encodedSVG = btoa(unescape(encodeURIComponent(uniqueSVG)));
                    return encodedSVG;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ SVG:', error);
            }
        }
        return null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    function initializePatternPreview(generator) {
        const patternSelect = document.getElementById('pattern-select');
        const patternPreview = document.getElementById('pattern-preview');
        const svgInput = document.getElementById('pattern-svg-input');
        
        if (patternSelect && patternPreview && svgInput) {
            function updatePatternPreview() {
                const selectedPattern = patternSelect.value;
                
                if (selectedPattern) {
                    try {
                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –£–ù–ò–ö–ê–õ–¨–ù–´–ô SVG –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞
                        const uniqueSVG = generator.generatePattern(selectedPattern);
                        if (uniqueSVG && uniqueSVG.includes('<svg')) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ
                            const encodedPattern = btoa(unescape(encodeURIComponent(uniqueSVG)));
                            patternPreview.style.backgroundImage = `url("data:image/svg+xml;base64,${encodedPattern}")`;
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –£–ù–ò–ö–ê–õ–¨–ù–´–ô SVG –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                            svgInput.value = uniqueSVG;
                        }
                    } catch (error) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                    }
                } else {
                    patternPreview.style.backgroundImage = 'none';
                    svgInput.value = '';
                }
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SVG –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            patternSelect.addEventListener('change', updatePatternPreview);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SVG –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const modal = document.getElementById('addSubjectModal');
            if (modal) {
                modal.addEventListener('show.bs.modal', function() {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SVG —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    updatePatternPreview();
                });
            }
            

        }
    }
});

function deleteSubject(subjectId) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç?')) {
        fetch(`/subject/${subjectId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `csrf_token={{ csrf_token() }}`
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–∞');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–∞');
        });
    }
}
</script>
{% endblock %} 