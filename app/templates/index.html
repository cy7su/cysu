{% extends 'base.html' %}
{% block title %}Главная{% endblock %}
{% block content %}

{% if not current_user.is_authenticated %}
<!-- Секция для неавторизованных пользователей -->
<section class="hero-container" style="min-height: calc(100vh - 200px); display: flex; align-items: center; justify-content: center;">
    <div class="container">
        <header class="text-center">
            <!-- Заголовок -->
            <div class="mb-5">
                <h1 class="display-5 fw-bold text-white mb-3">Добро пожаловать в cysu</h1>
                <p class="text-muted">ДЛЯ ВСЕХ ТЕХ КТО НЕНАВИДИТ MOODLE</p>
            </div>
            
            <!-- Быстрые возможности -->
            <section class="row g-3 justify-content-center mb-4">
                <div class="col-md-4">
                    <div class="quick-feature p-3" style="background: var(--dp-02); border: 1px solid var(--border-secondary); border-radius: 12px;">
                        <i class="fas fa-book text-primary mb-2"></i>
                        <h6 class="text-primary mb-1">Материалы</h6>
                        <small class="text-muted">Выкладываются в удобном формате</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="quick-feature p-3" style="background: var(--dp-02); border: 1px solid var(--border-secondary); border-radius: 12px;">
                        <i class="fas fa-code text-primary mb-2"></i>
                        <h6 class="text-primary mb-1">Практика</h6>
                        <small class="text-muted">Загружай решения, быстро и удобно</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="quick-feature p-3" style="background: var(--dp-02); border: 1px solid var(--border-secondary); border-radius: 12px;">
                        <i class="fas fa-comments text-primary mb-2"></i>
                        <h6 class="text-primary mb-1">Поддержка</h6>
                        <small class="text-muted">Чат и тикеты - решат все твои проблемы</small>
                    </div>
                </div>
            </section>
            
            <!-- Кнопки -->
            <nav class="d-flex gap-2 justify-content-center flex-wrap">
                <a href="{{ url_for('auth.register') }}" class="btn btn-primary btn-sm px-3">
                    Регистрация
                </a>
                <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary btn-sm px-3">
                    Войти
                </a>
            </nav>
        </header>
    </div>
</section>

<style>
.quick-feature {
    transition: all 0.2s ease;
}
.quick-feature:hover {
    border-color: var(--primary-color) !important;
    transform: translateY(-2px);
}
</style>

{% else %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
  <h2 class="mb-3 mb-md-0">Предметы</h2>
  {% if current_user.is_admin %}
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addSubjectModal" style="padding: 4px 12px !important; font-size: 0.85rem;">
        <i class="fas fa-plus d-md-none me-1"></i>Добавить предмет
    </button>
  {% endif %}
</div>
<div class="row g-4" style="column-gap: 80px;">
    {% for subject in subjects %}
    <div class="col-12 col-md-6 col-lg-4 col-xl-3">
        <div class="card shadow-sm subject-card" data-subject-id="{{ subject.id }}" data-url="{{ url_for('main.subject_detail', subject_id=subject.id) }}" onclick="window.location.href=this.getAttribute('data-url')">
            <!-- Изображение с SVG паттерном для соотношения 32:10 -->
            <div class="card-img dashboard-card-img" data-pattern-type="{{ subject.pattern_type or 'dots' }}" data-pattern-svg="{{ subject.pattern_svg or '' }}">
                <span class="sr-only">Изображение предмета</span>
            </div>
            
            <!-- Темное тело карточки -->
            <div class="card-body">
                <h6 class="card-title text-primary mb-1">{{ subject.title[:35]|e }}{% if subject.title|length > 35 %}...{% endif %}</h6>
                <p class="card-text text-muted mb-1">{{ subject.description[:70]|e }}{% if subject.description|length > 70 %}...{% endif %}</p>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12"><div class="alert alert-info">Нет предметов</div></div>
    {% endfor %}
</div>
{% if current_user.is_admin %}
<!-- Модальное окно добавления предмета -->
<div class="modal fade" id="addSubjectModal" tabindex="-1" aria-labelledby="addSubjectModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addSubjectModalLabel">Добавить предмет</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form method="post">
          <div class="modal-body">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="pattern_svg" id="pattern-svg-input" value="">
            <div class="mb-3">
              <label class="form-label">Название предмета</label>
              <input type="text" name="title" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Описание</label>
              <textarea name="description" class="form-control" style="min-height: 80px; resize: vertical;"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Фон предмета</label>
              <select id="pattern-select" name="pattern_type" class="form-select">
                <option value="dots">Точки</option>
                <option value="lines">Линии</option>
                <option value="grid">Сетка</option>
                <option value="circles">Круги</option>
                <option value="hexagons">Шестигранники</option>
                <option value="waves">Волны</option>
                <option value="stars">Звезды</option>
                <option value="triangles">Треугольники</option>
              </select>
            </div>
            <div class="mb-3">
              <div id="pattern-preview" class="pattern-preview"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-primary">Сохранить</button>
          </div>
        </form>
    </div>
  </div>
</div>
{% endif %}
{% endif %}

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/svg-patterns.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ждем загрузки SVGPatternGenerator
    function initializePatternGenerator() {
        // Сначала проверяем глобальный экземпляр
        if (window.patternGenerator && typeof window.patternGenerator.generatePattern === 'function') {
            const generator = window.patternGenerator;
            
            // Применяем паттерны к карточкам предметов
            applyPatternsToCards(generator);
            
            // Инициализируем предпросмотр в модальном окне
            initializePatternPreview(generator);
            return;
        }
        
        if (typeof SVGPatternGenerator === 'undefined') {
            // Пробуем еще 50 раз (5 секунд максимум)
            if (window.patternLoadAttempts === undefined) {
                window.patternLoadAttempts = 0;
            }
            if (window.patternLoadAttempts < 50) {
                window.patternLoadAttempts++;
                setTimeout(initializePatternGenerator, 100);
                return;
            } else {
                useFallbackPatterns();
                return;
            }
        }
        
        try {
            // Создаем экземпляр генератора
            const generator = new SVGPatternGenerator();
            
            // Применяем паттерны к карточкам предметов
            applyPatternsToCards(generator);
            
            // Инициализируем предпросмотр в модальном окне
            initializePatternPreview(generator);
            
        } catch (error) {
            useFallbackPatterns();
        }
    }
    
    // Запускаем инициализацию
    initializePatternGenerator();
    
    // Функция применения паттернов к карточкам
    function applyPatternsToCards(generator) {
        const subjectCards = document.querySelectorAll('.dashboard-card-img');
        
        if (subjectCards.length === 0) {
            return;
        }
        
        subjectCards.forEach(function(card, index) {
            // Проверяем, есть ли уже сохраненный SVG в базе данных
            const savedSvg = card.getAttribute('data-pattern-svg');
            const patternType = card.getAttribute('data-pattern-type');
            
            if (savedSvg && savedSvg.trim() !== '') {
                // Используем сохраненный SVG из базы данных
                try {
                    // Проверяем, является ли savedSvg уже base64 или обычным SVG
                    let svgToUse;
                    if (savedSvg.includes('<svg')) {
                        // Это обычный SVG, кодируем в base64
                        svgToUse = btoa(unescape(encodeURIComponent(savedSvg)));
                    } else {
                        // Это уже base64, используем как есть
                        svgToUse = savedSvg;
                    }
                    
                    card.style.backgroundImage = `url("data:image/svg+xml;base64,${svgToUse}")`;
                } catch (error) {
                    // Если ошибка с сохраненным SVG, генерируем новый
                    generateAndApplyPattern(card, generator, index);
                }
            } else {
                // Генерируем новый паттерн только если нет сохраненного
                generateAndApplyPattern(card, generator, index);
            }
        });
    }
    
    // Функция генерации и применения паттерна (используется только для новых предметов)
    function generateAndApplyPattern(card, generator, index) {
        const patternType = card.getAttribute('data-pattern-type') || 'dots';
        
        try {
            // Используем существующий генератор для создания уникального SVG
            const pattern = generator.generatePattern(patternType);
            if (pattern && pattern.includes('<svg')) {
                const encodedPattern = btoa(unescape(encodeURIComponent(pattern)));
                card.style.backgroundImage = `url("data:image/svg+xml;base64,${encodedPattern}")`;
            }
        } catch (error) {
            // Игнорируем ошибки
        }
    }
    
    // Функция для генерации уникального SVG при создании предмета
    function generateUniqueSVGForSubject(patternType) {
        if (window.patternGenerator && typeof window.patternGenerator.generatePattern === 'function') {
            try {
                // Генерируем уникальный SVG используя существующий генератор
                const uniqueSVG = window.patternGenerator.generatePattern(patternType);
                if (uniqueSVG && uniqueSVG.includes('<svg')) {
                    // Кодируем SVG для передачи в форму
                    const encodedSVG = btoa(unescape(encodeURIComponent(uniqueSVG)));
                    return encodedSVG;
                }
            } catch (error) {
                console.error('Ошибка генерации уникального SVG:', error);
            }
        }
        return null;
    }
    
    // Функция инициализации предпросмотра
    function initializePatternPreview(generator) {
        const patternSelect = document.getElementById('pattern-select');
        const patternPreview = document.getElementById('pattern-preview');
        const svgInput = document.getElementById('pattern-svg-input');
        
        if (patternSelect && patternPreview && svgInput) {
            function updatePatternPreview() {
                const selectedPattern = patternSelect.value;
                
                if (selectedPattern) {
                    try {
                        // Генерируем УНИКАЛЬНЫЙ SVG каждый раз при изменении типа
                        const uniqueSVG = generator.generatePattern(selectedPattern);
                        if (uniqueSVG && uniqueSVG.includes('<svg')) {
                            // Показываем в предпросмотре
                            const encodedPattern = btoa(unescape(encodeURIComponent(uniqueSVG)));
                            patternPreview.style.backgroundImage = `url("data:image/svg+xml;base64,${encodedPattern}")`;
                            
                            // Сохраняем УНИКАЛЬНЫЙ SVG в скрытое поле для передачи на сервер
                            svgInput.value = uniqueSVG;
                        }
                    } catch (error) {
                        // Игнорируем ошибки
                    }
                } else {
                    patternPreview.style.backgroundImage = 'none';
                    svgInput.value = '';
                }
            }
            
            // Генерируем SVG при изменении типа паттерна
            patternSelect.addEventListener('change', updatePatternPreview);
            
            // Генерируем SVG при открытии модального окна
            const modal = document.getElementById('addSubjectModal');
            if (modal) {
                modal.addEventListener('show.bs.modal', function() {
                    // Генерируем SVG только при открытии модального окна
                    updatePatternPreview();
                });
            }
            

        }
    }
});

function deleteSubject(subjectId) {
    if (confirm('Вы уверены, что хотите удалить этот предмет?')) {
        fetch(`/subject/${subjectId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `csrf_token={{ csrf_token() }}`
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Ошибка при удалении предмета');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при удалении предмета');
        });
    }
}
</script>
{% endblock %} 