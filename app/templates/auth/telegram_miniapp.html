{% extends 'base.html' %}
{% block title %}Вход через Telegram{% endblock %}
{% block content %}
<div class="d-flex justify-content-center align-items-center" style="min-height: 60vh;">
  <div class="card p-4 mx-3" style="min-width:280px; max-width: 400px; width:100%; border-radius: 12px;">
    <div class="text-center mb-4">
      <i class="fab fa-telegram fa-3x text-primary mb-3"></i>
      <h2 class="mb-0" style="font-size: 1.5rem;">Вход через Telegram</h2>
      <small class="text-muted">Для Telegram Mini App</small>
    </div>
    
    <div class="text-center">
      <p class="mb-4">Нажмите кнопку ниже для авторизации через Telegram</p>
      
      <button id="telegram-auth-btn" class="btn btn-primary btn-lg" style="padding: 12px 24px; font-size: 1rem; border-radius: 8px; min-height: 50px; width: 100%;">
        <i class="fab fa-telegram me-2"></i>
        Войти через Telegram
      </button>
      
      <div id="loading" class="mt-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-2 text-muted">Обработка авторизации...</p>
      </div>
      
      <div id="error-message" class="alert alert-danger mt-3" style="display: none;">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="error-text"></span>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const authBtn = document.getElementById('telegram-auth-btn');
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    
    // Проверяем, находимся ли мы в Telegram Mini App
    const isTelegramWebApp = window.Telegram && window.Telegram.WebApp;
    
    if (isTelegramWebApp) {
        // В Telegram Mini App - используем Telegram WebApp API
        authBtn.addEventListener('click', function() {
            authBtn.style.display = 'none';
            loading.style.display = 'block';
            
            // Запрашиваем авторизацию через Telegram WebApp
            window.Telegram.WebApp.requestWriteAccess().then(() => {
                // Получаем данные пользователя
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                
                if (user) {
                    // Отправляем данные на сервер
                    sendAuthData({
                        id: user.id,
                        first_name: user.first_name || '',
                        last_name: user.last_name || '',
                        username: user.username || '',
                        photo_url: user.photo_url || '',
                        auth_date: Math.floor(Date.now() / 1000),
                        hash: 'miniapp_auth' // Специальный хеш для Mini App
                    });
                } else {
                    showError('Не удалось получить данные пользователя');
                }
            }).catch(error => {
                showError('Ошибка авторизации: ' + error.message);
            });
        });
    } else {
        // В обычном браузере - используем OAuth URL
        authBtn.addEventListener('click', function() {
            authBtn.style.display = 'none';
            loading.style.display = 'block';
            
            // Создаем OAuth URL для Telegram
            const botId = '8102415932'; // ID бота
            const origin = encodeURIComponent(window.location.origin);
            const returnTo = encodeURIComponent(window.location.href);
            
            const oauthUrl = `https://oauth.telegram.org/auth?bot_id=${botId}&origin=${origin}&embed=1&request_access=write&return_to=${returnTo}`;
            
            // Открываем OAuth в том же окне
            window.location.href = oauthUrl;
        });
    }
    
    function sendAuthData(authData) {
        fetch('{{ url_for("telegram_auth.telegram_login") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(authData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Успешная авторизация - перенаправляем
                window.location.href = data.redirect_url || '{{ url_for("main.index") }}';
            } else {
                showError(data.message || 'Ошибка авторизации через Telegram');
            }
        })
        .catch(error => {
            showError('Ошибка авторизации через Telegram: ' + error.message);
        });
    }
    
    function showError(message) {
        loading.style.display = 'none';
        errorMessage.style.display = 'block';
        errorText.textContent = message;
        
        // Показываем кнопку снова
        authBtn.style.display = 'block';
    }
    
    // Проверяем, есть ли параметры OAuth в URL (возврат из OAuth)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('id') && urlParams.get('hash')) {
        // Это возврат из OAuth - обрабатываем автоматически
        const authData = {
            id: urlParams.get('id'),
            first_name: urlParams.get('first_name') || '',
            last_name: urlParams.get('last_name') || '',
            username: urlParams.get('username') || '',
            photo_url: urlParams.get('photo_url') || '',
            auth_date: urlParams.get('auth_date'),
            hash: urlParams.get('hash')
        };
        
        authBtn.style.display = 'none';
        loading.style.display = 'block';
        sendAuthData(authData);
    }
});
</script>
{% endblock %}
