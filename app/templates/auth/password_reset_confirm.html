{% extends "base.html" %}

{% block title %}Восстановление пароля{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-5 col-md-7 col-12">
            <div class="verification-card">
                <div class="verification-header">
                    <div class="verification-logo" style="background: none; border-radius: 0;">
                        <img src="{{ url_for('static', filename='icons/favicon-48x48.png') }}" alt="Логотип сайта" style="width: 48px; height: 48px;">
                    </div>
                    <h1 class="verification-title">Восстановление пароля</h1>
                </div>

                <div class="verification-content">
                    <p class="verification-text">Введите код восстановления и новый пароль для завершения процедуры.</p>
                    <p class="verification-text">Код действителен в течение 15 минут.</p>
                </div>

                <form method="POST" class="verification-form">
                    {{ form.hidden_tag() }}
                    
                    <div class="code-input-container">
                        <label class="code-label">Код восстановления из письма:</label>
                        <div class="code-inputs">
                            <input type="text" class="code-input" maxlength="1" data-index="0" autocomplete="off">
                            <input type="text" class="code-input" maxlength="1" data-index="1" autocomplete="off">
                            <input type="text" class="code-input" maxlength="1" data-index="2" autocomplete="off">
                            <input type="text" class="code-input" maxlength="1" data-index="3" autocomplete="off">
                            <input type="text" class="code-input" maxlength="1" data-index="4" autocomplete="off">
                            <input type="text" class="code-input" maxlength="1" data-index="5" autocomplete="off">
                        </div>
                        {% if form.code.errors %}
                            <div class="code-error-message">
                                {% for error in form.code.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    {{ form.code(id="full-code", type="hidden") }}

                    <div class="form-group">
                        <label class="form-label">Новый пароль</label>
                        <div class="password-input-wrapper">
                            {{ form.new_password(class="form-input", placeholder="Введите новый пароль") }}
                            <button type="button" class="password-toggle" onclick="togglePassword('new_password')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.new_password.errors %}
                            <div class="code-error-message">
                                {% for error in form.new_password.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="form-label">Подтвердите пароль</label>
                        <div class="password-input-wrapper">
                            {{ form.confirm_password(class="form-input", placeholder="Подтвердите новый пароль") }}
                            <button type="button" class="password-toggle" onclick="togglePassword('confirm_password')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.confirm_password.errors %}
                            <div class="code-error-message">
                                {% for error in form.confirm_password.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <button type="submit" class="verification-submit">
                        Восстановить пароль
                    </button>
                </form>

                <div class="verification-footer">
                    <p class="resend-text">Не получили код? <a href="{{ url_for('auth.password_reset_request') }}" class="resend-link">Запросить новый код</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const codeInputs = document.querySelectorAll('.code-input');
    const hiddenInput = document.getElementById('full-code');
    const errorMessage = document.querySelector('.code-error-message');
    
    // Функция для очистки всех полей
    function clearAllInputs() {
        codeInputs.forEach(input => {
            input.value = '';
            input.classList.remove('error');
        });
        hiddenInput.value = '';
        if (errorMessage) {
            errorMessage.style.display = 'none';
        }
        codeInputs[0].focus();
    }
    
    // Функция для показа ошибки
    function showError() {
        codeInputs.forEach(input => {
            input.classList.add('error');
        });
        if (errorMessage) {
            errorMessage.style.display = 'block';
        }
    }
    
    // Проверяем, есть ли ошибки при загрузке страницы
    if (errorMessage && errorMessage.textContent.trim()) {
        showError();
        // Очищаем поля при ошибке, но оставляем сообщение об ошибке
        codeInputs.forEach(input => {
            input.value = '';
            input.classList.add('error');
        });
        hiddenInput.value = '';
        codeInputs[0].focus();
    }
    
    // Функция для обновления скрытого поля формы
    function updateFormCode() {
        let fullCode = '';
        codeInputs.forEach(input => {
            fullCode += input.value || '';
        });
        hiddenInput.value = fullCode;
        
        // Если код полностью введен (6 цифр), автоматически отправляем форму
        if (fullCode.length === 6) {
            setTimeout(() => {
                document.querySelector('.verification-form').submit();
            }, 300); // Небольшая задержка для лучшего UX
        }
    }
    
    // Функция для перехода к следующему полю
    function moveToNext(currentIndex) {
        if (currentIndex < codeInputs.length - 1) {
            codeInputs[currentIndex + 1].focus();
        }
    }
    
    // Функция для перехода к предыдущему полю
    function moveToPrevious(currentIndex) {
        if (currentIndex > 0) {
            codeInputs[currentIndex - 1].focus();
        }
    }
    
    // Обработчики для каждого поля
    codeInputs.forEach((input, index) => {
        // Обработчик ввода
        input.addEventListener('input', function(e) {
            // Убираем ошибку при вводе
            input.classList.remove('error');
            if (errorMessage) {
                errorMessage.style.display = 'none';
            }
            
            // Разрешаем только цифры
            const value = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = value;
            
            updateFormCode();
            
            // Если введена цифра, переходим к следующему полю
            if (value) {
                moveToNext(index);
            }
        });
        
        // Обработчик клавиш
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace') {
                if (e.target.value === '') {
                    moveToPrevious(index);
                } else {
                    e.target.value = '';
                    updateFormCode();
                }
            } else if (e.key === 'ArrowLeft') {
                moveToPrevious(index);
            } else if (e.key === 'ArrowRight') {
                moveToNext(index);
            }
        });
        
        // Обработчик вставки
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
            const digits = pastedData.split('');
            
            digits.forEach((digit, i) => {
                if (index + i < codeInputs.length) {
                    codeInputs[index + i].value = digit;
                }
            });
            
            updateFormCode();
            
            // Фокусируемся на последнем заполненном поле
            const lastFilledIndex = Math.min(index + digits.length - 1, codeInputs.length - 1);
            codeInputs[lastFilledIndex].focus();
        });
    });
});

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}
</script>
{% endblock %} 