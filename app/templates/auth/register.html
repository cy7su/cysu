{% extends "base.html" %}

{% block title %}Регистрация{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-5 col-md-7 col-12">
            <div class="registration-card">
                <div class="registration-header">
                    <div class="registration-logo">
                        <img src="{{ url_for('static', filename='icons/favicon-48x48.png') }}" alt="Логотип сайта" style="width: 48px; height: 48px;">
                    </div>
                    <h1 class="registration-title">Регистрация</h1>
                </div>

                <form method="POST" class="registration-form">
                    {{ form.hidden_tag() }}
                    
                    <div class="form-group">
                        <label class="form-label">Логин</label>
                        {{ form.username(class="form-input" + (" is-invalid" if form.username.errors else ""), placeholder='Введите логин', autocomplete='username') }}
                        {% if form.username.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.username.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">E-mail</label>
                        {{ form.email(class="form-input" + (" is-invalid" if form.email.errors else ""), placeholder='Введите E-mail', autocomplete='email') }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.email.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Пароль</label>
                        <div class="password-input-wrapper">
                            {{ form.password(class="form-input" + (" is-invalid" if form.password.errors else ""), placeholder='Введите пароль', autocomplete='new-password', id='password', required=True) }}
                            <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        {% if form.password.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.password.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Группа</label>
                        {{ form.group_id(class="form-input" + (" is-invalid" if form.group_id.errors else "")) }}
                        {% if form.group_id.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.group_id.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" required>
                            <span class="checkmark"></span>
                            Я согласен с <a href="{{ url_for('main.terms') }}" class="terms-link">правилами</a>.
                        </label>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn-primary disabled" id="submitBtn" disabled>
                            Создать аккаунт
                        </button>
                    </div>
                    
                    <div class="login-link">
                        <a href="{{ url_for('auth.login') }}" class="btn-secondary">
                            Вход
                        </a>
                    </div>
                </form>
                
                <div class="divider">
                    <span>или</span>
                </div>
                
                <div class="social-login">
                    <a href="{{ url_for('telegram_auth.telegram_login') }}" class="social-btn telegram-btn">
                        <i class="fab fa-telegram"></i>
                        <span>Telegram</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Функция для переключения видимости пароля
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const toggle = input.parentNode.querySelector('.password-toggle i');
    
    if (input.type === 'password') {
        input.type = 'text';
        toggle.classList.remove('fa-eye');
        toggle.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        toggle.classList.remove('fa-eye-slash');
        toggle.classList.add('fa-eye');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.registration-form');
    const submitBtn = document.getElementById('submitBtn');
    const checkbox = document.querySelector('input[type="checkbox"]');
    
    // Функция для обновления состояния кнопки
    function updateButtonState() {
        if (checkbox.checked) {
            submitBtn.classList.remove('disabled');
            submitBtn.disabled = false;
        } else {
            submitBtn.classList.add('disabled');
            submitBtn.disabled = true;
        }
    }
    
    // Инициализация состояния кнопки
    updateButtonState();
    
    // Обработчик изменения чекбокса
    if (checkbox) {
        checkbox.addEventListener('change', updateButtonState);
    }
    
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            // Проверяем валидность формы перед отправкой
            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
                form.classList.add('was-validated');
                return false;
            }
            
            // Проверяем, что чекбокс отмечен
            if (!checkbox.checked) {
                e.preventDefault();
                return false;
            }
            
            // Показываем индикатор загрузки только если форма валидна
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Создание аккаунта...';
            submitBtn.disabled = true;
            
            // Устанавливаем таймаут для восстановления кнопки
            setTimeout(function() {
                if (submitBtn.disabled) {
                    submitBtn.innerHTML = 'Создать аккаунт';
                    updateButtonState();
                }
            }, 15000); // 15 секунд
        });
    }
});
</script>
{% endblock %} 