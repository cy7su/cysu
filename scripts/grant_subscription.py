import os
import sys

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from datetime import date, datetime

from app import create_app, db
from app.models import User


def grant_subscription(username):
    app = create_app()
    with app.app_context():
        user = User.query.filter_by(username=username).first()
        if not user:
            print(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –Ω–∏–∫–æ–º '{username}' –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False
        print(f"–ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.username} (ID: {user.id})")
        print(f"Email: {user.email}")
        print(f"–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: {'–ê–∫—Ç–∏–≤–Ω–∞' if user.is_subscribed else '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}")
        if user.subscription_expires:
            print(f"–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {user.subscription_expires.strftime('%d.%m.%Y')}")
        subscription_end = datetime(2099, 12, 31, 23, 59, 59)
        user.is_subscribed = True
        user.subscription_expires = subscription_end
        user.is_manual_subscription = True
        db.session.commit()
        print(f"‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –≤—ã–¥–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.username}")
        print(f"üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {subscription_end.strftime('%d.%m.%Y')}")
        print(f"‚è∞ –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è: {subscription_end.strftime('%H:%M:%S')}")
        return True
def main():
    if len(sys.argv) != 2:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python3 scripts/grant_subscription.py <username>")
        print("–ü—Ä–∏–º–µ—Ä: python3 scripts/grant_subscription.py john_doe")
        sys.exit(1)
    username = sys.argv[1]
    print(f"üéØ –í—ã–¥–∞—á–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {username}")
    print("=" * 50)
    success = grant_subscription(username)
    if success:
        print("=" * 50)
        print("‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
    else:
        print("=" * 50)
        print("‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –æ—à–∏–±–∫–æ–π!")
        sys.exit(1)
if __name__ == '__main__':
    main()
